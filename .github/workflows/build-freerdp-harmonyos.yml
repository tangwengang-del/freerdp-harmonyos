# GitHub Actions Workflow for Building FreeRDP HarmonyOS Native Libraries
# Repository: tangwengang-del/freerdp-harmonyos
#
# 使用说明:
# 1. 需要在GitHub仓库的Secrets中配置 OHOS_NDK_URL (HarmonyOS NDK下载地址)
# 2. NDK版本必须与目标设备系统版本兼容
# 3. 使用 musl-based 工具链确保与 HarmonyOS 兼容

name: Build FreeRDP HarmonyOS (arm64-v8a)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      freerdp_version:
        description: 'FreeRDP version to build'
        required: false
        default: '3.10.3'
      debug_build:
        description: 'Enable debug build'
        required: false
        default: 'false'

env:
  FREERDP_VERSION: ${{ github.event.inputs.freerdp_version || '3.10.3' }}
  OPENSSL_VERSION: "3.0.15"
  FFMPEG_VERSION: "6.1.2"
  CJSON_VERSION: "1.7.18"
  ZLIB_VERSION: "1.3.1"
  # HarmonyOS SDK版本 - API 12
  OHOS_API_VERSION: "12"
  # musl 工具链版本
  MUSL_VERSION: "1.2.5"

jobs:
  build-arm64:
    name: Build arm64-v8a Native Libraries (OHOS/musl)
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            git \
            wget \
            curl \
            unzip \
            python3 \
            python3-pip \
            nasm \
            yasm \
            autoconf \
            automake \
            libtool \
            texinfo \
            patchelf

      - name: Setup OHOS NDK / musl-based Toolchain
        run: |
          echo "=== Setting up HarmonyOS/OHOS Compatible Toolchain ==="
          
          mkdir -p $HOME/ohos-toolchain
          cd $HOME/ohos-toolchain
          
          # 方案1: 使用 OHOS NDK (如果提供了下载地址)
          if [ -n "${{ secrets.OHOS_NDK_URL }}" ]; then
            echo "Downloading OHOS NDK..."
            wget -q "${{ secrets.OHOS_NDK_URL }}" -O ohos-ndk.zip
            unzip -q ohos-ndk.zip
            
            # 设置 OHOS NDK 路径
            export OHOS_NDK_HOME=$(find . -maxdepth 2 -name "native" -type d | head -1)
            echo "OHOS_NDK_HOME=$OHOS_NDK_HOME" >> $GITHUB_ENV
            echo "Found OHOS NDK at: $OHOS_NDK_HOME"
            
            # 使用 OHOS NDK 的 clang
            echo "CC=$OHOS_NDK_HOME/llvm/bin/clang" >> $GITHUB_ENV
            echo "CXX=$OHOS_NDK_HOME/llvm/bin/clang++" >> $GITHUB_ENV
            echo "AR=$OHOS_NDK_HOME/llvm/bin/llvm-ar" >> $GITHUB_ENV
            echo "RANLIB=$OHOS_NDK_HOME/llvm/bin/llvm-ranlib" >> $GITHUB_ENV
            echo "STRIP=$OHOS_NDK_HOME/llvm/bin/llvm-strip" >> $GITHUB_ENV
            echo "USE_OHOS_NDK=true" >> $GITHUB_ENV
          else
            # 方案2: 使用 musl-cross-make 构建 musl 工具链
            echo "Building musl-based cross-compiler for OHOS compatibility..."
            
            # 尝试多个下载源
            MUSL_DOWNLOADED=false
            
            # 尝试从 musl.cc 下载
            echo "Trying to download from musl.cc..."
            if wget --timeout=60 -q https://musl.cc/aarch64-linux-musl-cross.tgz -O aarch64-linux-musl-cross.tgz 2>/dev/null; then
              MUSL_DOWNLOADED=true
              echo "Downloaded from musl.cc"
            fi
            
            # 尝试备用源 - 使用更稳定的 GitHub release
            if [ "$MUSL_DOWNLOADED" = "false" ]; then
              echo "Trying backup source from more-mirrors..."
              if wget --timeout=60 -q https://more.musl.cc/11/x86_64-linux-musl/aarch64-linux-musl-cross.tgz -O aarch64-linux-musl-cross.tgz 2>/dev/null; then
                MUSL_DOWNLOADED=true
                echo "Downloaded from more.musl.cc"
              fi
            fi
            
            # 如果仍然失败，尝试使用 curl
            if [ "$MUSL_DOWNLOADED" = "false" ]; then
              echo "Trying with curl..."
              if curl -L --connect-timeout 60 -o aarch64-linux-musl-cross.tgz https://musl.cc/aarch64-linux-musl-cross.tgz 2>/dev/null; then
                MUSL_DOWNLOADED=true
                echo "Downloaded using curl"
              fi
            fi
            
            # 检查是否下载成功
            if [ "$MUSL_DOWNLOADED" = "false" ] || [ ! -f "aarch64-linux-musl-cross.tgz" ]; then
              echo "ERROR: Failed to download musl toolchain from all sources"
              echo "Falling back to system cross-compiler..."
              
              # 回退到系统的交叉编译器
              sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
              
              echo "CC=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
              echo "CXX=aarch64-linux-gnu-g++" >> $GITHUB_ENV
              echo "AR=aarch64-linux-gnu-ar" >> $GITHUB_ENV
              echo "RANLIB=aarch64-linux-gnu-ranlib" >> $GITHUB_ENV
              echo "STRIP=aarch64-linux-gnu-strip" >> $GITHUB_ENV
              echo "READELF=aarch64-linux-gnu-readelf" >> $GITHUB_ENV
              echo "OBJDUMP=aarch64-linux-gnu-objdump" >> $GITHUB_ENV
              echo "USE_OHOS_NDK=false" >> $GITHUB_ENV
              echo "MUSL_TOOLCHAIN=" >> $GITHUB_ENV
              echo "USING_GLIBC=true" >> $GITHUB_ENV
              
              echo "WARNING: Using glibc cross-compiler as fallback"
            else
              # 解压 musl 工具链
              tar xzf aarch64-linux-musl-cross.tgz
              
              MUSL_TOOLCHAIN=$HOME/ohos-toolchain/aarch64-linux-musl-cross
              
              echo "CC=$MUSL_TOOLCHAIN/bin/aarch64-linux-musl-gcc" >> $GITHUB_ENV
              echo "CXX=$MUSL_TOOLCHAIN/bin/aarch64-linux-musl-g++" >> $GITHUB_ENV
              echo "AR=$MUSL_TOOLCHAIN/bin/aarch64-linux-musl-ar" >> $GITHUB_ENV
              echo "RANLIB=$MUSL_TOOLCHAIN/bin/aarch64-linux-musl-ranlib" >> $GITHUB_ENV
              echo "STRIP=$MUSL_TOOLCHAIN/bin/aarch64-linux-musl-strip" >> $GITHUB_ENV
              echo "READELF=$MUSL_TOOLCHAIN/bin/aarch64-linux-musl-readelf" >> $GITHUB_ENV
              echo "OBJDUMP=$MUSL_TOOLCHAIN/bin/aarch64-linux-musl-objdump" >> $GITHUB_ENV
              echo "MUSL_TOOLCHAIN=$MUSL_TOOLCHAIN" >> $GITHUB_ENV
              echo "PATH=$MUSL_TOOLCHAIN/bin:$PATH" >> $GITHUB_ENV
              echo "USE_OHOS_NDK=false" >> $GITHUB_ENV
              echo "USING_GLIBC=false" >> $GITHUB_ENV
              
              echo "musl toolchain installed at: $MUSL_TOOLCHAIN"
              ls -la $MUSL_TOOLCHAIN/bin/
            fi
          fi

      - name: Create OHOS/musl Toolchain File
        run: |
          if [ "$USE_OHOS_NDK" = "true" ]; then
            # OHOS NDK toolchain file
            cat > $HOME/ohos-toolchain.cmake << EOF
          # HarmonyOS OHOS NDK Toolchain File for arm64-v8a
          set(CMAKE_SYSTEM_NAME OHOS)
          set(CMAKE_SYSTEM_PROCESSOR aarch64)
          set(CMAKE_OHOS_ARCH_ABI arm64-v8a)
          
          # OHOS NDK Clang
          set(CMAKE_C_COMPILER $ENV{CC})
          set(CMAKE_CXX_COMPILER $ENV{CXX})
          set(CMAKE_AR $ENV{AR})
          set(CMAKE_RANLIB $ENV{RANLIB})
          set(CMAKE_STRIP $ENV{STRIP})
          
          # OHOS specific flags
          set(CMAKE_C_FLAGS "\${CMAKE_C_FLAGS} -target aarch64-linux-ohos -fPIC -ffunction-sections -fdata-sections")
          set(CMAKE_CXX_FLAGS "\${CMAKE_CXX_FLAGS} -target aarch64-linux-ohos -fPIC -ffunction-sections -fdata-sections")
          set(CMAKE_SHARED_LINKER_FLAGS "\${CMAKE_SHARED_LINKER_FLAGS} -Wl,--gc-sections -Wl,--as-needed")
          
          # Search paths
          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)
          
          set(CMAKE_POSITION_INDEPENDENT_CODE ON)
          EOF
          else
            # musl-based toolchain file (OHOS compatible)
            cat > $HOME/ohos-toolchain.cmake << EOF
          # musl-based Toolchain File for HarmonyOS/OHOS arm64-v8a
          # HarmonyOS uses musl libc, so we use musl cross-compiler
          set(CMAKE_SYSTEM_NAME Linux)
          set(CMAKE_SYSTEM_PROCESSOR aarch64)
          
          # musl cross compiler
          set(CMAKE_C_COMPILER $ENV{CC})
          set(CMAKE_CXX_COMPILER $ENV{CXX})
          set(CMAKE_AR $ENV{AR})
          set(CMAKE_RANLIB $ENV{RANLIB})
          set(CMAKE_STRIP $ENV{STRIP})
          
          # Build flags - static linking to avoid runtime dependencies
          set(CMAKE_C_FLAGS "\${CMAKE_C_FLAGS} -fPIC -ffunction-sections -fdata-sections -Os")
          set(CMAKE_CXX_FLAGS "\${CMAKE_CXX_FLAGS} -fPIC -ffunction-sections -fdata-sections -Os")
          set(CMAKE_EXE_LINKER_FLAGS "\${CMAKE_EXE_LINKER_FLAGS} -Wl,--gc-sections -static-libgcc")
          set(CMAKE_SHARED_LINKER_FLAGS "\${CMAKE_SHARED_LINKER_FLAGS} -Wl,--gc-sections -Wl,--as-needed")
          
          # Important: Don't link against glibc-specific libraries
          set(CMAKE_C_FLAGS "\${CMAKE_C_FLAGS} -D_GNU_SOURCE")
          set(CMAKE_CXX_FLAGS "\${CMAKE_CXX_FLAGS} -D_GNU_SOURCE")
          
          # Search paths
          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)
          
          set(CMAKE_POSITION_INDEPENDENT_CODE ON)
          EOF
          fi
          
          echo "TOOLCHAIN_FILE=$HOME/ohos-toolchain.cmake" >> $GITHUB_ENV
          echo "Created toolchain file:"
          cat $HOME/ohos-toolchain.cmake

      - name: Build zlib
        run: |
          echo "=== Building zlib ${{ env.ZLIB_VERSION }} ==="
          cd ${{ github.workspace }}
          
          wget -q https://zlib.net/zlib-${{ env.ZLIB_VERSION }}.tar.gz
          tar xzf zlib-${{ env.ZLIB_VERSION }}.tar.gz
          cd zlib-${{ env.ZLIB_VERSION }}
          
          # Use musl compiler
          CFLAGS="-fPIC -Os" \
          ./configure \
            --prefix=${{ github.workspace }}/install/zlib \
            --static
          
          make -j$(nproc)
          make install
          
          # Also build shared library
          make clean
          CFLAGS="-fPIC -Os" \
          ./configure \
            --prefix=${{ github.workspace }}/install/zlib
          
          make -j$(nproc)
          make install
          
          echo "zlib build completed"
          ls -la ${{ github.workspace }}/install/zlib/lib/

      - name: Build cJSON
        run: |
          echo "=== Building cJSON ${{ env.CJSON_VERSION }} ==="
          cd ${{ github.workspace }}
          
          wget -q https://github.com/DaveGamble/cJSON/archive/refs/tags/v${{ env.CJSON_VERSION }}.tar.gz -O cjson.tar.gz
          tar xzf cjson.tar.gz
          cd cJSON-${{ env.CJSON_VERSION }}
          
          mkdir build && cd build
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$TOOLCHAIN_FILE \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install/cjson \
            -DENABLE_CJSON_TEST=OFF \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON
          
          make -j$(nproc)
          make install
          
          echo "cJSON build completed"
          ls -la ${{ github.workspace }}/install/cjson/lib/

      - name: Build OpenSSL for OHOS/musl
        run: |
          echo "=== Building OpenSSL ${{ env.OPENSSL_VERSION }} for OHOS/musl ==="
          cd ${{ github.workspace }}
          
          wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          tar xzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          cd openssl-${{ env.OPENSSL_VERSION }}
          
          # Configure for aarch64 with musl
          # Use linux-aarch64 but with musl cross-compiler
          ./Configure linux-aarch64 \
            --cross-compile-prefix=aarch64-linux-musl- \
            --prefix=${{ github.workspace }}/install/openssl \
            --openssldir=${{ github.workspace }}/install/openssl/ssl \
            shared \
            no-tests \
            no-asm \
            -fPIC \
            -Os
          
          make -j$(nproc)
          make install_sw
          
          echo "OpenSSL build completed"
          ls -la ${{ github.workspace }}/install/openssl/lib*/
          
          # Verify no glibc dependency
          echo "Checking library dependencies..."
          file ${{ github.workspace }}/install/openssl/lib*/libssl.so* || true

      - name: Build FFmpeg for OHOS/musl
        run: |
          echo "=== Building FFmpeg ${{ env.FFMPEG_VERSION }} for OHOS/musl ==="
          cd ${{ github.workspace }}
          
          wget -q https://ffmpeg.org/releases/ffmpeg-${{ env.FFMPEG_VERSION }}.tar.xz
          tar xJf ffmpeg-${{ env.FFMPEG_VERSION }}.tar.xz
          cd ffmpeg-${{ env.FFMPEG_VERSION }}
          
          # Configure for aarch64 with musl cross-compilation
          ./configure \
            --prefix=${{ github.workspace }}/install/ffmpeg \
            --enable-cross-compile \
            --cross-prefix=aarch64-linux-musl- \
            --target-os=linux \
            --arch=aarch64 \
            --enable-shared \
            --disable-static \
            --disable-programs \
            --disable-doc \
            --disable-debug \
            --enable-pic \
            --enable-small \
            --disable-everything \
            --enable-decoder=h264 \
            --enable-decoder=hevc \
            --enable-decoder=aac \
            --enable-decoder=mp3 \
            --enable-decoder=pcm_s16le \
            --enable-decoder=pcm_u8 \
            --enable-parser=h264 \
            --enable-parser=hevc \
            --enable-parser=aac \
            --enable-demuxer=h264 \
            --enable-demuxer=hevc \
            --enable-demuxer=aac \
            --enable-protocol=file \
            --enable-swscale \
            --enable-swresample \
            --enable-avcodec \
            --enable-avformat \
            --enable-avutil \
            --extra-cflags="-fPIC -Os" \
            --extra-ldflags="-fPIC"
          
          make -j$(nproc)
          make install
          
          echo "FFmpeg build completed"
          ls -la ${{ github.workspace }}/install/ffmpeg/lib/

      - name: Clone and Build FreeRDP
        run: |
          echo "=== Cloning FreeRDP ${{ env.FREERDP_VERSION }} ==="
          cd ${{ github.workspace }}
          
          git clone --depth 1 --branch ${{ env.FREERDP_VERSION }} \
            https://github.com/FreeRDP/FreeRDP.git \
            ${{ github.workspace }}/FreeRDP
          
          cd FreeRDP
          mkdir build && cd build
          
          # Set library paths
          export PKG_CONFIG_PATH="${{ github.workspace }}/install/zlib/lib/pkgconfig:${{ github.workspace }}/install/openssl/lib/pkgconfig:${{ github.workspace }}/install/openssl/lib64/pkgconfig:${{ github.workspace }}/install/ffmpeg/lib/pkgconfig:${{ github.workspace }}/install/cjson/lib/pkgconfig"
          export OPENSSL_ROOT_DIR="${{ github.workspace }}/install/openssl"
          export FFMPEG_DIR="${{ github.workspace }}/install/ffmpeg"
          export cJSON_DIR="${{ github.workspace }}/install/cjson"
          export ZLIB_ROOT="${{ github.workspace }}/install/zlib"
          
          echo "=== Building FreeRDP ==="
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$TOOLCHAIN_FILE \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install/freerdp \
            -DCMAKE_PREFIX_PATH="${{ github.workspace }}/install/zlib;${{ github.workspace }}/install/openssl;${{ github.workspace }}/install/ffmpeg;${{ github.workspace }}/install/cjson" \
            -DZLIB_ROOT=${{ github.workspace }}/install/zlib \
            -DZLIB_INCLUDE_DIR=${{ github.workspace }}/install/zlib/include \
            -DZLIB_LIBRARY=${{ github.workspace }}/install/zlib/lib/libz.so \
            -DOPENSSL_ROOT_DIR=${{ github.workspace }}/install/openssl \
            -DOPENSSL_INCLUDE_DIR=${{ github.workspace }}/install/openssl/include \
            -DOPENSSL_CRYPTO_LIBRARY=${{ github.workspace }}/install/openssl/lib/libcrypto.so \
            -DOPENSSL_SSL_LIBRARY=${{ github.workspace }}/install/openssl/lib/libssl.so \
            -DWITH_SERVER=OFF \
            -DWITH_SAMPLE=OFF \
            -DWITH_CUPS=OFF \
            -DWITH_PULSE=OFF \
            -DWITH_ALSA=OFF \
            -DWITH_OSS=OFF \
            -DWITH_FFMPEG=ON \
            -DWITH_SWSCALE=ON \
            -DWITH_X11=OFF \
            -DWITH_WAYLAND=OFF \
            -DWITH_GSTREAMER_0_10=OFF \
            -DWITH_GSTREAMER_1_0=OFF \
            -DWITH_LIBSYSTEMD=OFF \
            -DWITH_PCSC=OFF \
            -DWITH_JPEG=OFF \
            -DWITH_OPENH264=OFF \
            -DWITH_GSM=OFF \
            -DWITH_LAME=OFF \
            -DWITH_FAAD2=OFF \
            -DWITH_FAAC=OFF \
            -DWITH_SOXR=OFF \
            -DWITH_OPUS=OFF \
            -DWITH_PKCS11=OFF \
            -DWITH_ICU=OFF \
            -DWITH_KRB5=OFF \
            -DWITH_UNICODE_BUILTIN=ON \
            -DWITH_INTERNAL_RC4=ON \
            -DWITH_INTERNAL_MD4=ON \
            -DWITH_INTERNAL_MD5=ON \
            -DWITH_FUSE=OFF \
            -DWITH_CLIENT_INTERFACE=OFF \
            -DWITH_PROXY=OFF \
            -DWITH_SHADOW=OFF \
            -DWITH_CLIENT=OFF \
            -DWITH_CLIENT_SDL=OFF \
            -DWITH_MANPAGES=OFF \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DWITH_CLIENT_CHANNELS=ON \
            -DWITH_CHANNELS=ON \
            -DCHANNEL_URBDRC=OFF \
            -DCHANNEL_SMARTCARD=OFF
          
          cmake --build . --parallel $(nproc) || {
            echo "Build failed, trying with reduced parallelism..."
            cmake --build . --parallel 2
          }
          
          cmake --install .
          
          echo "FreeRDP build completed"
          ls -la ${{ github.workspace }}/install/freerdp/lib*/

      - name: Collect and verify artifacts
        run: |
          echo "=== Collecting build artifacts ==="
          mkdir -p ${{ github.workspace }}/artifacts/arm64-v8a
          
          # Copy all libraries
          find ${{ github.workspace }}/install/zlib -name "*.so*" -exec cp {} ${{ github.workspace }}/artifacts/arm64-v8a/ \; 2>/dev/null || true
          find ${{ github.workspace }}/install/cjson -name "*.so*" -exec cp {} ${{ github.workspace }}/artifacts/arm64-v8a/ \; 2>/dev/null || true
          find ${{ github.workspace }}/install/openssl -name "*.so*" -exec cp {} ${{ github.workspace }}/artifacts/arm64-v8a/ \; 2>/dev/null || true
          find ${{ github.workspace }}/install/ffmpeg -name "*.so*" -exec cp {} ${{ github.workspace }}/artifacts/arm64-v8a/ \; 2>/dev/null || true
          find ${{ github.workspace }}/install/freerdp -name "*.so*" -exec cp {} ${{ github.workspace }}/artifacts/arm64-v8a/ \; 2>/dev/null || true
          
          cd ${{ github.workspace }}/artifacts/arm64-v8a
          
          # Resolve symlinks - keep real files only
          for f in *.so*; do
            if [ -L "$f" ]; then
              target=$(readlink -f "$f")
              rm "$f"
              if [ -f "$target" ] && [ ! -f "$(basename $target)" ]; then
                cp "$target" "$(basename $target)"
              fi
            fi
          done
          
          # Remove duplicates and create proper symlinks
          # Keep only base .so files for HarmonyOS
          for f in *.so.*.*.*; do
            base=$(echo $f | sed 's/\.[0-9]*\.[0-9]*\.[0-9]*$//')
            if [ ! -f "$base" ]; then
              cp "$f" "$base" 2>/dev/null || true
            fi
          done
          
          # Strip debug symbols
          $STRIP --strip-unneeded *.so* 2>/dev/null || aarch64-linux-musl-strip --strip-unneeded *.so* 2>/dev/null || true
          
          echo "=== Verifying library dependencies (should NOT show ld-linux-aarch64.so.1) ==="
          for lib in *.so*; do
            echo "--- $lib ---"
            $READELF -d "$lib" 2>/dev/null | grep -E "(NEEDED|INTERP)" || aarch64-linux-musl-readelf -d "$lib" 2>/dev/null | grep -E "(NEEDED|INTERP)" || true
          done
          
          # Check for problematic glibc dependencies
          echo ""
          echo "=== Checking for glibc dependencies (should be empty) ==="
          for lib in *.so*; do
            deps=$($READELF -d "$lib" 2>/dev/null | grep "ld-linux" || true)
            if [ -n "$deps" ]; then
              echo "WARNING: $lib has glibc dependency: $deps"
            fi
          done
          
          echo ""
          echo "=== Final artifacts ==="
          ls -la

      - name: Create library list
        run: |
          cd ${{ github.workspace }}/artifacts/arm64-v8a
          echo "FreeRDP HarmonyOS Libraries (musl-based)" > README.txt
          echo "Built: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> README.txt
          echo "FreeRDP Version: ${{ env.FREERDP_VERSION }}" >> README.txt
          echo "OpenSSL Version: ${{ env.OPENSSL_VERSION }}" >> README.txt
          echo "FFmpeg Version: ${{ env.FFMPEG_VERSION }}" >> README.txt
          echo "cJSON Version: ${{ env.CJSON_VERSION }}" >> README.txt
          echo "zlib Version: ${{ env.ZLIB_VERSION }}" >> README.txt
          echo "Toolchain: musl libc (HarmonyOS compatible)" >> README.txt
          echo "" >> README.txt
          echo "Libraries:" >> README.txt
          ls -la *.so* >> README.txt 2>/dev/null || true

      - name: Upload arm64-v8a artifacts
        uses: actions/upload-artifact@v4
        with:
          name: freerdp-harmonyos-arm64-v8a
          path: ${{ github.workspace }}/artifacts/arm64-v8a/
          retention-days: 90
          if-no-files-found: warn

  # Create Release Package
  package:
    name: Package Libraries
    needs: [build-arm64]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download arm64-v8a artifacts
        uses: actions/download-artifact@v4
        with:
          name: freerdp-harmonyos-arm64-v8a
          path: libs/arm64-v8a

      - name: Create release package
        run: |
          echo "=== Creating release package ==="
          cd libs
          
          # Create version info
          echo "FreeRDP HarmonyOS Native Libraries (musl-based)" > VERSION.txt
          echo "Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> VERSION.txt
          echo "Git SHA: ${{ github.sha }}" >> VERSION.txt
          echo "Compatible with: HarmonyOS 3.x/4.x/5.x (musl libc)" >> VERSION.txt
          
          # Create zip package
          zip -r ../freerdp-harmonyos-libs.zip .
          
          echo "Package contents:"
          unzip -l ../freerdp-harmonyos-libs.zip
          
          # Calculate checksums
          cd ..
          sha256sum freerdp-harmonyos-libs.zip > freerdp-harmonyos-libs.zip.sha256

      - name: Upload complete package
        uses: actions/upload-artifact@v4
        with:
          name: freerdp-harmonyos-complete
          path: |
            freerdp-harmonyos-libs.zip
            freerdp-harmonyos-libs.zip.sha256
          retention-days: 90

  # Create GitHub Release (on tag push)
  release:
    name: Create Release
    needs: [package]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download package
        uses: actions/download-artifact@v4
        with:
          name: freerdp-harmonyos-complete
          path: release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/freerdp-harmonyos-libs.zip
            release/freerdp-harmonyos-libs.zip.sha256
          body: |
            ## FreeRDP HarmonyOS Native Libraries
            
            ### Important: musl-based Build
            This release is built with musl libc toolchain, which is compatible with HarmonyOS.
            Previous builds using glibc (ld-linux-aarch64.so.1) are NOT compatible with HarmonyOS.
            
            ### Included Libraries
            - FreeRDP (RDP client library)
            - OpenSSL (TLS/SSL)
            - FFmpeg (Audio/Video codecs)
            - cJSON (JSON parsing)
            - zlib (compression)
            
            ### Architecture
            - arm64-v8a (64-bit ARM, musl libc)
            
            ### Compatibility
            - HarmonyOS 3.x, 4.x, 5.x, 6.x
            - Uses musl libc (ld-musl-aarch64.so.1)
            
            ### Installation
            1. Download `freerdp-harmonyos-libs.zip`
            2. Extract to `entry/libs/arm64-v8a/`
            3. Build your HarmonyOS project
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
