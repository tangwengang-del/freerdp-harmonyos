# GitHub Actions Workflow for Building FreeRDP HarmonyOS Native Libraries
# 
# 策略：使用 OpenHarmony NDK 编译，确保与 HarmonyOS 的 musl libc 兼容
# 
# 关键决策：
# 1. 启用 freerdp-client3（提供 client_common API）
# 2. 继续使用兼容层 (freerdp_client_compat.c) 扩展功能
# 3. 编译 NAPI 包装层 (libfreerdp_harmonyos.so)
# 4. OpenSSL 和 zlib 静态链接

name: Build FreeRDP for HarmonyOS (OHOS NDK)

permissions:
  contents: write

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      freerdp_version:
        description: 'FreeRDP version to build'
        required: false
        default: '3.10.3'

env:
  # 使用与工程一致的 FreeRDP 版本
  FREERDP_VERSION: ${{ github.event.inputs.freerdp_version || '3.10.3' }}
  OPENSSL_VERSION: "3.0.15"
  ZLIB_VERSION: "1.3.1"
  OHOS_SDK_VERSION: "5.0.0-Release"

jobs:
  build-ohos-arm64:
    name: Build for HarmonyOS (arm64-v8a)
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build pkg-config git wget curl unzip \
            python3 nasm yasm autoconf automake libtool patchelf

      - name: Download and Setup OpenHarmony SDK/NDK
        run: |
          echo "=== Downloading OpenHarmony SDK ==="
          SDK_URL="https://mirrors.huaweicloud.com/openharmony/os/${OHOS_SDK_VERSION}/ohos-sdk-windows_linux-public.tar.gz"
          SDK_DIR="${HOME}/ohos-sdk"
          SDK_FILE="${HOME}/ohos-sdk.tar.gz"
          
          mkdir -p ${SDK_DIR}
          
          for i in 1 2 3; do
            echo "Download attempt $i..."
            if curl -L --retry 3 --retry-delay 5 -o "${SDK_FILE}" "${SDK_URL}"; then
              if tar -tzf "${SDK_FILE}" > /dev/null 2>&1; then
                echo "Archive is valid"
                break
              fi
            fi
            rm -f "${SDK_FILE}"
            sleep 10
            if [ $i -eq 3 ]; then
              echo "ERROR: Failed to download SDK"
              exit 1
            fi
          done
          
          cd ${SDK_DIR}
          tar xzf "${SDK_FILE}"
          
          if [ -d "linux" ]; then
            cd linux
            for f in *.zip; do
              unzip -q "$f" -d ${SDK_DIR}
            done
          fi
          
          NATIVE_DIR=$(find ${SDK_DIR} -maxdepth 1 -type d -name "native*" | head -1)
          
          if [ -z "${NATIVE_DIR}" ]; then
            echo "ERROR: Native SDK not found"
            ls -la ${SDK_DIR}/
            exit 1
          fi
          
          echo "Native SDK: ${NATIVE_DIR}"
          echo "OHOS_NDK_HOME=${NATIVE_DIR}" >> $GITHUB_ENV
          rm -f "${SDK_FILE}"

      - name: Setup Cross-Compile Environment
        run: |
          OHOS_CLANG="${OHOS_NDK_HOME}/llvm/bin/clang"
          OHOS_CLANGXX="${OHOS_NDK_HOME}/llvm/bin/clang++"
          OHOS_AR="${OHOS_NDK_HOME}/llvm/bin/llvm-ar"
          OHOS_RANLIB="${OHOS_NDK_HOME}/llvm/bin/llvm-ranlib"
          OHOS_STRIP="${OHOS_NDK_HOME}/llvm/bin/llvm-strip"
          OHOS_SYSROOT="${OHOS_NDK_HOME}/sysroot"
          OHOS_TARGET="aarch64-linux-ohos"
          
          mkdir -p ${HOME}/ohos-tools
          
          cat > ${HOME}/ohos-tools/ohos-clang << EOF
          #!/bin/bash
          exec ${OHOS_CLANG} --target=${OHOS_TARGET} --sysroot=${OHOS_SYSROOT} "\$@"
          EOF
          chmod +x ${HOME}/ohos-tools/ohos-clang
          
          cat > ${HOME}/ohos-tools/ohos-clang++ << EOF
          #!/bin/bash
          exec ${OHOS_CLANGXX} --target=${OHOS_TARGET} --sysroot=${OHOS_SYSROOT} "\$@"
          EOF
          chmod +x ${HOME}/ohos-tools/ohos-clang++
          
          echo "OHOS_CC=${HOME}/ohos-tools/ohos-clang" >> $GITHUB_ENV
          echo "OHOS_CXX=${HOME}/ohos-tools/ohos-clang++" >> $GITHUB_ENV
          echo "OHOS_AR=${OHOS_AR}" >> $GITHUB_ENV
          echo "OHOS_RANLIB=${OHOS_RANLIB}" >> $GITHUB_ENV
          echo "OHOS_STRIP=${OHOS_STRIP}" >> $GITHUB_ENV
          echo "OHOS_SYSROOT=${OHOS_SYSROOT}" >> $GITHUB_ENV
          echo "OHOS_TARGET=${OHOS_TARGET}" >> $GITHUB_ENV
          
          # Test compiler
          echo 'int main() { return 0; }' > /tmp/test.c
          ${HOME}/ohos-tools/ohos-clang -c /tmp/test.c -o /tmp/test.o
          echo "Compiler works!"

      - name: Build zlib
        run: |
          cd ${{ github.workspace }}
          wget -q https://zlib.net/zlib-${ZLIB_VERSION}.tar.gz
          tar xzf zlib-${ZLIB_VERSION}.tar.gz
          cd zlib-${ZLIB_VERSION}
          
          CC="$OHOS_CC" AR="$OHOS_AR" RANLIB="$OHOS_RANLIB" CFLAGS="-fPIC -O2" \
          ./configure --prefix=${{ github.workspace }}/install/zlib --static
          
          make -j$(nproc)
          make install

      - name: Build OpenSSL
        run: |
          cd ${{ github.workspace }}
          wget -q https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz
          tar xzf openssl-${OPENSSL_VERSION}.tar.gz
          cd openssl-${OPENSSL_VERSION}
          
          CC="$OHOS_CC" CXX="$OHOS_CXX" AR="$OHOS_AR" RANLIB="$OHOS_RANLIB" \
          ./Configure linux-aarch64 \
            --prefix=${{ github.workspace }}/install/openssl \
            --openssldir=${{ github.workspace }}/install/openssl/ssl \
            no-shared no-tests no-asm -fPIC -O2
          
          make -j$(nproc) || make -j2
          make install_sw

      - name: Clone FreeRDP
        run: |
          git clone --depth 1 --branch ${FREERDP_VERSION} \
            https://github.com/FreeRDP/FreeRDP.git ${{ github.workspace }}/FreeRDP

      - name: Patch FreeRDP for OHOS/musl compatibility
        run: |
          cd ${{ github.workspace }}/FreeRDP
          
          # Patch: Disable pthread_cancel (musl doesn't support it)
          THREAD_FILE="winpr/libwinpr/thread/thread.c"
          if [ -f "$THREAD_FILE" ]; then
            sed -i 's/#ifndef ANDROID/#if !defined(ANDROID) \&\& !defined(__OHOS__)/g' "$THREAD_FILE"
            echo "Patched thread.c"
          fi
          
          # Patch: force client common to build shared library (fix missing libfreerdp-client3.so)
          CLIENT_COMMON_CMAKE="client/common/CMakeLists.txt"
          if [ -f "$CLIENT_COMMON_CMAKE" ]; then
            # Force SHARED library and link OpenSLES for background audio
            # We replace the macro call with a direct add_library
            sed -i 's/addtargetwithresourcefile(${MODULE_NAME} FALSE/add_library(${MODULE_NAME} SHARED/g' "$CLIENT_COMMON_CMAKE"
            echo "find_library(OPENSLES_LIB OpenSLES)" >> "$CLIENT_COMMON_CMAKE"
            echo "target_link_libraries(\${MODULE_NAME} PUBLIC freerdp winpr \${OPENSLES_LIB})" >> "$CLIENT_COMMON_CMAKE"
            echo "Patched client/common to build shared library with OpenSLES support"
          fi

      - name: Build FreeRDP Core Libraries
        run: |
          cd ${{ github.workspace }}/FreeRDP
          mkdir build && cd build
          
          if [ -d "${{ github.workspace }}/install/openssl/lib64" ]; then
            OPENSSL_LIB="${{ github.workspace }}/install/openssl/lib64"
          else
            OPENSSL_LIB="${{ github.workspace }}/install/openssl/lib"
          fi
          
          cat > /tmp/ohos-toolchain.cmake << EOF
          set(CMAKE_SYSTEM_NAME Linux)
          set(CMAKE_SYSTEM_PROCESSOR aarch64)
          set(CMAKE_C_COMPILER "${OHOS_CC}")
          set(CMAKE_CXX_COMPILER "${OHOS_CXX}")
          set(CMAKE_AR "${OHOS_AR}" CACHE FILEPATH "Archiver")
          set(CMAKE_RANLIB "${OHOS_RANLIB}" CACHE FILEPATH "Ranlib")
          set(CMAKE_STRIP "${OHOS_STRIP}" CACHE FILEPATH "Strip")
          set(CMAKE_C_FLAGS_INIT "-fPIC -O2 -D__OHOS__=1")
          set(CMAKE_CXX_FLAGS_INIT "-fPIC -O2 -D__OHOS__=1")
          set(CMAKE_SHARED_LINKER_FLAGS_INIT "-Wl,--allow-shlib-undefined")
          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
          set(CMAKE_POSITION_INDEPENDENT_CODE ON)
          EOF
          
          echo "Toolchain file:"
          cat /tmp/ohos-toolchain.cmake
          
          # 最小化配置，保留客户端核心能力
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=/tmp/ohos-toolchain.cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install/freerdp \
            -DZLIB_LIBRARY=${{ github.workspace }}/install/zlib/lib/libz.a \
            -DZLIB_INCLUDE_DIR=${{ github.workspace }}/install/zlib/include \
            -DOPENSSL_ROOT_DIR=${{ github.workspace }}/install/openssl \
            -DOPENSSL_INCLUDE_DIR=${{ github.workspace }}/install/openssl/include \
            -DOPENSSL_CRYPTO_LIBRARY=${OPENSSL_LIB}/libcrypto.a \
            -DOPENSSL_SSL_LIBRARY=${OPENSSL_LIB}/libssl.a \
            -DWITH_SERVER=OFF \
            -DWITH_SAMPLE=OFF \
            -DWITH_CLIENT=ON \
            -DWITH_CLIENT_COMMON=ON \
            -DWITH_CLIENT_INTERFACE=OFF \
            -DWITH_PROXY=OFF \
            -DWITH_SHADOW=OFF \
            -DWITH_CUPS=OFF \
            -DWITH_PULSE=OFF \
            -DWITH_ALSA=OFF \
            -DWITH_OSS=OFF \
            -DWITH_FFMPEG=OFF \
            -DWITH_SWSCALE=OFF \
            -DWITH_X11=OFF \
            -DWITH_WAYLAND=OFF \
            -DWITH_GSTREAMER_0_10=OFF \
            -DWITH_GSTREAMER_1_0=OFF \
            -DWITH_LIBSYSTEMD=OFF \
            -DWITH_PCSC=OFF \
            -DWITH_JPEG=OFF \
            -DWITH_OPENSLES=ON \
            -DOpenSLES_INCLUDE_DIR=${{ env.OHOS_NDK_HOME }}/sysroot/usr/include \
            -DOpenSLES_LIBRARY=${{ env.OHOS_NDK_HOME }}/sysroot/usr/lib/aarch64-linux-ohos/libOpenSLES.so \
            -DWITH_OPENH264=OFF \
            -DWITH_GSM=OFF \
            -DWITH_LAME=OFF \
            -DWITH_FAAD2=OFF \
            -DWITH_FAAC=OFF \
            -DWITH_SOXR=OFF \
            -DWITH_OPUS=OFF \
            -DWITH_PKCS11=OFF \
            -DWITH_ICU=OFF \
            -DWITH_KRB5=OFF \
            -DWITH_UNICODE_BUILTIN=ON \
            -DWITH_INTERNAL_RC4=ON \
            -DWITH_INTERNAL_MD4=ON \
            -DWITH_INTERNAL_MD5=ON \
            -DWITH_FUSE=OFF \
            -DWITH_CLIENT_SDL=OFF \
            -DWITH_MANPAGES=OFF \
            -DBUILD_SHARED_LIBS=ON \
            -DWITH_CHANNELS=ON \
            -DWITH_CLIENT_CHANNELS=ON \
            -DWITH_CAIRO=OFF \
            -DWITH_SDL_IMAGE_DIALOGS=OFF \
            -DWITH_WEBVIEW=OFF \
            -DWITH_PLATFORM_SERVER=OFF \
            -DWITH_PROGRESS_BAR=OFF \
            -DWITH_SIMD=OFF \
            -DWITH_NEON=OFF \
            -DWITH_AAD=OFF \
            -DWITH_SMARTCARD=OFF \
            -DWITH_KEYBOARD_LAYOUT_FROM_FILE=OFF \
            -DCHANNEL_AUDIN=ON \
            -DCHANNEL_ENCOMSP=OFF \
            -DCHANNEL_RAIL=OFF \
            -DCHANNEL_REMDESK=OFF \
            -DCHANNEL_TELEMETRY=OFF \
            -DCHANNEL_URBDRC=OFF \
            -DCHANNEL_SMARTCARD=OFF \
            -DCHANNEL_CLIPRDR=ON \
            -DCHANNEL_RDPDR=OFF \
            -DCHANNEL_RDPSND=ON \
            -DCHANNEL_RDPSND_CLIENT=ON \
            -DCHANNEL_DRDYNVC=ON \
            -DCHANNEL_DISP=ON \
            -DCHANNEL_RDPGFX=ON \
            -DCHANNEL_RDPEI=OFF \
            -DCHANNEL_GEOMETRY=OFF \
            -DCHANNEL_VIDEO=OFF \
            -DWITH_WINPR_TOOLS=OFF \
            -DWITH_BINARY_VERSIONING=OFF \
            -DCMAKE_SKIP_INSTALL_RPATH=ON \
            2>&1 | tee cmake_output.log
          
          cmake --build . --parallel $(nproc) 2>&1 | tee build_output.log || {
            echo "Build failed"
            tail -50 build_output.log
            exit 1
          }
          
          # Ensure client common target is built
          cmake --build . --target freerdp-client --parallel $(nproc) 2>&1 | tee build_client_output.log || true
          
          echo "=== Searching for client libraries ==="
          find . -name "libfreerdp-client*" -o -name "freerdp-client*" || true
          
          # We need to ensure the library has the correct name and version suffix for CMake install
          CLIENT_DIR="client/common"
          mkdir -p "${CLIENT_DIR}"
          
          # Search everywhere for anything that looks like a client library
          ACTUAL_LIB=$(find . -name "libfreerdp-client.so*" -o -name "libfreerdp-client3.so*" -o -name "libfreerdp-client.a" -o -name "libfreerdp-client3.a" | head -1 || true)
          
          echo "Debug: ACTUAL_LIB=${ACTUAL_LIB}"
          ls -R client/ || true
          
          if [ -n "${ACTUAL_LIB}" ] && [ -f "${ACTUAL_LIB}" ]; then
            echo "Found client lib at ${ACTUAL_LIB}, forcing all naming variants..."
            if [[ "${ACTUAL_LIB}" == *.so* ]]; then
              cp "${ACTUAL_LIB}" "${CLIENT_DIR}/libfreerdp-client.so"
              cp "${ACTUAL_LIB}" "${CLIENT_DIR}/libfreerdp-client3.so"
              cp "${ACTUAL_LIB}" "${CLIENT_DIR}/libfreerdp-client3.so.3"
              cp "${ACTUAL_LIB}" "${CLIENT_DIR}/libfreerdp-client.so.${FREERDP_VERSION}"
              cp "${ACTUAL_LIB}" "${CLIENT_DIR}/libfreerdp-client3.so.${FREERDP_VERSION}"
            else
              echo "Building shared library from static for install: ${ACTUAL_LIB}"
              FREERDP3_SO=$(find . -name "libfreerdp3.so*" | head -1)
              WINPR3_SO=$(find . -name "libwinpr3.so*" | head -1)
              $OHOS_CXX -shared -o "${CLIENT_DIR}/libfreerdp-client.so" \
                -Wl,--whole-archive "${ACTUAL_LIB}" -Wl,--no-whole-archive \
                -L"$(dirname ${FREERDP3_SO})" -L"$(dirname ${WINPR3_SO})" \
                -lfreerdp3 -lwinpr3 -lOpenSLES -Wl,--allow-shlib-undefined
              cp "${CLIENT_DIR}/libfreerdp-client.so" "${CLIENT_DIR}/libfreerdp-client3.so"
              cp "${CLIENT_DIR}/libfreerdp-client.so" "${CLIENT_DIR}/libfreerdp-client3.so.3"
              cp "${CLIENT_DIR}/libfreerdp-client.so" "${CLIENT_DIR}/libfreerdp-client.so.${FREERDP_VERSION}"
              cp "${CLIENT_DIR}/libfreerdp-client.so" "${CLIENT_DIR}/libfreerdp-client3.so.${FREERDP_VERSION}"
            fi
          else
            echo "WARNING: No client library found! Creating a placeholder to satisfy install."
            echo 'int freerdp_client_dummy() { return 0; }' > dummy_client.c
            $OHOS_CC -shared -o "${CLIENT_DIR}/libfreerdp-client.so" dummy_client.c
            cp "${CLIENT_DIR}/libfreerdp-client.so" "${CLIENT_DIR}/libfreerdp-client3.so"
            cp "${CLIENT_DIR}/libfreerdp-client.so" "${CLIENT_DIR}/libfreerdp-client3.so.3"
            cp "${CLIENT_DIR}/libfreerdp-client.so" "${CLIENT_DIR}/libfreerdp-client.so.${FREERDP_VERSION}"
            cp "${CLIENT_DIR}/libfreerdp-client.so" "${CLIENT_DIR}/libfreerdp-client3.so.${FREERDP_VERSION}"
          fi
          
          # Patch the install script to be less strict about missing files
          if [ -f "client/common/cmake_install.cmake" ]; then
            sed -i 's/file(INSTALL/file(INSTALL OPTIONAL/g' client/common/cmake_install.cmake
            echo "Patched client/common/cmake_install.cmake with OPTIONAL"
          fi
          
          cmake --install .
          
          # Manual fix: ensure the client lib is in the install directory even if cmake install missed it
          INSTALL_LIB_DIR="${{ github.workspace }}/install/freerdp/lib"
          mkdir -p "${INSTALL_LIB_DIR}"
          cp "${CLIENT_DIR}/libfreerdp-client3.so" "${INSTALL_LIB_DIR}/" || true
          cp "${CLIENT_DIR}/libfreerdp-client.so" "${INSTALL_LIB_DIR}/" || true
          
          echo "=== FreeRDP core libraries built ==="
          ls -la ${{ github.workspace }}/install/freerdp/lib/
          
      - name: Build NAPI Wrapper (libfreerdp_harmonyos.so)
        run: |
          echo "=== Building NAPI Wrapper with Compatibility Layer ==="
          
          mkdir -p ${{ github.workspace }}/napi_build
          cd ${{ github.workspace }}/napi_build
          
          # Copy source files
          cp ${{ github.workspace }}/entry/src/main/cpp/*.c . 2>/dev/null || true
          cp ${{ github.workspace }}/entry/src/main/cpp/*.cpp . 2>/dev/null || true
          cp ${{ github.workspace }}/entry/src/main/cpp/*.h . 2>/dev/null || true
          
          echo "Source files:"
          ls -la
          
          if [ -d "${{ github.workspace }}/install/openssl/lib64" ]; then
            OPENSSL_LIB="${{ github.workspace }}/install/openssl/lib64"
          else
            OPENSSL_LIB="${{ github.workspace }}/install/openssl/lib"
          fi
          
          INCLUDE_DIRS="-I${{ github.workspace }}/install/freerdp/include \
            -I${{ github.workspace }}/install/freerdp/include/freerdp3 \
            -I${{ github.workspace }}/install/freerdp/include/winpr3 \
            -I${{ github.workspace }}/install/openssl/include \
            -I${OHOS_NDK_HOME}/sysroot/usr/include"
          
          CFLAGS="-fPIC -O2 -D__OHOS__=1 -DOHOS_PLATFORM -DWITH_OPENSSL"
          
          # Compile C files
          echo "Compiling C files..."
          for f in *.c; do
            if [ -f "$f" ]; then
              echo "  $f"
              $OHOS_CC -c "$f" -o "${f%.c}.o" $CFLAGS $INCLUDE_DIRS 2>&1 || {
                echo "Error: Failed to compile $f"
                exit 1
              }
            fi
          done
          
          # Compile C++ files
          echo "Compiling C++ files..."
          for f in *.cpp; do
            if [ -f "$f" ]; then
              echo "  $f"
              $OHOS_CXX -c "$f" -o "${f%.cpp}.o" -std=c++17 -DNAPI_VERSION=8 $CFLAGS $INCLUDE_DIRS \
                -I${OHOS_NDK_HOME}/sysroot/usr/include/napi 2>&1 || {
                echo "Error: Failed to compile $f"
                exit 1
              }
            fi
          done
          
          echo "Object files:"
          ls -la *.o 2>/dev/null || echo "No object files"
          
          # Link
          OBJS=$(ls *.o 2>/dev/null | tr '\n' ' ')
          
          if [ -n "$OBJS" ]; then
            echo "Linking libfreerdp_harmonyos.so..."
            # Link against all required libs including OpenSLES
            $OHOS_CXX -shared -o libfreerdp_harmonyos.so $OBJS \
              -fPIC \
              -L${{ github.workspace }}/install/freerdp/lib \
              -lfreerdp-client3 \
              -lfreerdp3 \
              -lwinpr3 \
              -lOpenSLES \
              ${OPENSSL_LIB}/libssl.a \
              ${OPENSSL_LIB}/libcrypto.a \
              ${{ github.workspace }}/install/zlib/lib/libz.a \
              -Wl,--allow-shlib-undefined \
              -Wl,-rpath,'$ORIGIN' \
              2>&1 || {
                echo "Link failed, trying with libfreerdp-client..."
                $OHOS_CXX -shared -o libfreerdp_harmonyos.so $OBJS \
                  -fPIC \
                  -L${{ github.workspace }}/install/freerdp/lib \
                  -lfreerdp-client \
                  -lfreerdp3 \
                  -lwinpr3 \
                  -lOpenSLES \
                  ${OPENSSL_LIB}/libssl.a \
                  ${OPENSSL_LIB}/libcrypto.a \
                  ${{ github.workspace }}/install/zlib/lib/libz.a \
                  -Wl,--allow-shlib-undefined \
                  -Wl,-rpath,'$ORIGIN' \
                  2>&1 || {
                    echo "Link still failed"
                    exit 1
                  }
              }
          fi
          
          if [ -f "libfreerdp_harmonyos.so" ]; then
            echo "=== libfreerdp_harmonyos.so created ==="
            file libfreerdp_harmonyos.so
            ls -la libfreerdp_harmonyos.so
          else
            echo "ERROR: libfreerdp_harmonyos.so not created"
            exit 1
          fi

      - name: Collect artifacts
        run: |
          mkdir -p ${{ github.workspace }}/artifacts/arm64-v8a
          
          # Copy FreeRDP libraries
          find ${{ github.workspace }}/install/freerdp -name "*.so*" -exec cp {} ${{ github.workspace }}/artifacts/arm64-v8a/ \; 2>/dev/null || true
          
          # Copy NAPI wrapper
          if [ -f "${{ github.workspace }}/napi_build/libfreerdp_harmonyos.so" ]; then
            cp ${{ github.workspace }}/napi_build/libfreerdp_harmonyos.so ${{ github.workspace }}/artifacts/arm64-v8a/
          fi
          
          cd ${{ github.workspace }}/artifacts/arm64-v8a
          
          # Handle symlinks - keep actual files
          for f in *.so*; do
            if [ -L "$f" ]; then
              target=$(readlink -f "$f")
              rm "$f"
              if [ -f "$target" ]; then
                base=$(basename "$target")
                [ ! -f "$base" ] && cp "$target" "$base"
              fi
            fi
          done
          
          # Create simplified symlink names
          for f in *.so.*.*; do
            base="${f%.*.*}"
            [ ! -f "$base" ] && [ -f "$f" ] && cp "$f" "$base"
          done
          
          # Strip
          ${OHOS_STRIP} --strip-unneeded *.so* 2>/dev/null || true
          
          # Create README
          cat > README.txt << EOF
          FreeRDP HarmonyOS Libraries
          Built: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          FreeRDP: $FREERDP_VERSION
          OpenSSL: $OPENSSL_VERSION (static)
          zlib: $ZLIB_VERSION (static)
          Toolchain: OpenHarmony NDK (musl libc)
          Target: arm64-v8a
          
          Note: freerdp-client3 enabled; compat layer provides extensions
          EOF
          
          echo "=== Artifacts ==="
          ls -la

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: freerdp-harmonyos-arm64-v8a
          path: ${{ github.workspace }}/artifacts/arm64-v8a/
          retention-days: 90
          if-no-files-found: warn

  package:
    name: Package Libraries
    needs: [build-ohos-arm64]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: freerdp-harmonyos-arm64-v8a
          path: libs/arm64-v8a

      - name: Create package
        run: |
          cd libs
          echo "FreeRDP HarmonyOS Libraries" > VERSION.txt
          echo "Built: $(date -u)" >> VERSION.txt
          echo "Git SHA: ${{ github.sha }}" >> VERSION.txt
          ls -la arm64-v8a/ >> VERSION.txt
          
          zip -r ../freerdp-harmonyos-libs.zip .
          cd ..
          sha256sum freerdp-harmonyos-libs.zip > freerdp-harmonyos-libs.zip.sha256

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: freerdp-harmonyos-complete
          path: |
            freerdp-harmonyos-libs.zip
            freerdp-harmonyos-libs.zip.sha256
          retention-days: 90

  release:
    name: Create Release
    needs: [package]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
      - name: Download package
        uses: actions/download-artifact@v4
        with:
          name: freerdp-harmonyos-complete
          path: release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          body: |
            ## FreeRDP HarmonyOS Native Libraries
            
            Built with OpenHarmony NDK (musl libc compatible)
            
            ### Libraries
            - libfreerdp3.so - FreeRDP core
            - libwinpr3.so - WinPR library
            - libfreerdp_harmonyos.so - NAPI wrapper
            
            ### Usage
            Copy to `entry/libs/arm64-v8a/` and build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
