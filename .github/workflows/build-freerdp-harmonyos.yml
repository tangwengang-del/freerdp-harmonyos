# GitHub Actions Workflow for Building FreeRDP HarmonyOS Native Libraries
# 策略：使用 OpenHarmony NDK 编译，确保与 HarmonyOS 的 musl libc 兼容
# 修复：添加补丁禁用 pthread_cancel（musl libc 不支持）

name: Build FreeRDP for HarmonyOS (OHOS NDK)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      freerdp_version:
        description: 'FreeRDP version to build'
        required: false
        default: '3.10.3'

env:
  # 使用 FreeRDP 3.5.1 - 更稳定的版本
  FREERDP_VERSION: ${{ github.event.inputs.freerdp_version || '3.5.1' }}
  OPENSSL_VERSION: "3.0.15"
  ZLIB_VERSION: "1.3.1"
  OHOS_SDK_VERSION: "5.0.0-Release"

jobs:
  build-ohos-arm64:
    name: Build for HarmonyOS (arm64-v8a, OHOS NDK)
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build pkg-config git wget curl unzip \
            python3 nasm yasm autoconf automake libtool patchelf

      - name: Download and Setup OpenHarmony SDK/NDK
        run: |
          echo "=== Downloading OpenHarmony SDK ==="
          SDK_URL="https://mirrors.huaweicloud.com/openharmony/os/${OHOS_SDK_VERSION}/ohos-sdk-windows_linux-public.tar.gz"
          SDK_DIR="${HOME}/ohos-sdk"
          SDK_FILE="${HOME}/ohos-sdk.tar.gz"
          
          mkdir -p ${SDK_DIR}
          
          # 下载 SDK（带重试机制）
          echo "Downloading SDK from ${SDK_URL}..."
          for i in 1 2 3; do
            echo "Download attempt $i..."
            if curl -L --retry 3 --retry-delay 5 -o "${SDK_FILE}" "${SDK_URL}"; then
              echo "Download completed, verifying..."
              if tar -tzf "${SDK_FILE}" > /dev/null 2>&1; then
                echo "Archive is valid"
                break
              else
                echo "Archive is corrupted, retrying..."
                rm -f "${SDK_FILE}"
              fi
            else
              echo "Download failed, retrying..."
              sleep 10
            fi
            if [ $i -eq 3 ]; then
              echo "ERROR: Failed to download SDK after 3 attempts"
              exit 1
            fi
          done
          
          # 解压 SDK
          echo "Extracting SDK..."
          cd ${SDK_DIR}
          tar xzf "${SDK_FILE}"
          
          # 解压 Linux SDK 组件
          if [ -d "linux" ]; then
            cd linux
            for f in *.zip; do
              echo "Extracting $f..."
              unzip -q "$f" -d ${SDK_DIR}
            done
          fi
          
          # 查找 NDK 路径
          NATIVE_DIR=$(find ${SDK_DIR} -maxdepth 1 -type d -name "native*" | head -1)
          
          if [ -z "${NATIVE_DIR}" ]; then
            echo "ERROR: Native SDK not found"
            echo "SDK directory contents:"
            ls -la ${SDK_DIR}/
            exit 1
          fi
          
          echo "Native SDK: ${NATIVE_DIR}"
          echo "OHOS_NDK_HOME=${NATIVE_DIR}" >> $GITHUB_ENV
          
          # 清理下载的压缩包
          rm -f "${SDK_FILE}"

      - name: Setup Cross-Compile Environment
        run: |
          echo "=== Setting up cross-compile environment ==="
          
          # 编译器路径
          OHOS_CLANG="${OHOS_NDK_HOME}/llvm/bin/clang"
          OHOS_CLANGXX="${OHOS_NDK_HOME}/llvm/bin/clang++"
          OHOS_AR="${OHOS_NDK_HOME}/llvm/bin/llvm-ar"
          OHOS_RANLIB="${OHOS_NDK_HOME}/llvm/bin/llvm-ranlib"
          OHOS_STRIP="${OHOS_NDK_HOME}/llvm/bin/llvm-strip"
          OHOS_SYSROOT="${OHOS_NDK_HOME}/sysroot"
          OHOS_TARGET="aarch64-linux-ohos"
          
          # 验证编译器
          echo "Testing compiler..."
          echo 'int main() { return 0; }' > /tmp/test.c
          ${OHOS_CLANG} --target=${OHOS_TARGET} --sysroot=${OHOS_SYSROOT} -c /tmp/test.c -o /tmp/test.o
          echo "Compiler works!"
          
          # 创建编译器包装脚本
          mkdir -p ${HOME}/ohos-tools
          
          echo '#!/bin/bash' > ${HOME}/ohos-tools/ohos-clang
          echo "exec ${OHOS_CLANG} --target=${OHOS_TARGET} --sysroot=${OHOS_SYSROOT} \"\$@\"" >> ${HOME}/ohos-tools/ohos-clang
          chmod +x ${HOME}/ohos-tools/ohos-clang
          
          echo '#!/bin/bash' > ${HOME}/ohos-tools/ohos-clang++
          echo "exec ${OHOS_CLANGXX} --target=${OHOS_TARGET} --sysroot=${OHOS_SYSROOT} \"\$@\"" >> ${HOME}/ohos-tools/ohos-clang++
          chmod +x ${HOME}/ohos-tools/ohos-clang++
          
          # 保存路径为完整的绝对路径
          echo "OHOS_CC=${HOME}/ohos-tools/ohos-clang" >> $GITHUB_ENV
          echo "OHOS_CXX=${HOME}/ohos-tools/ohos-clang++" >> $GITHUB_ENV
          echo "OHOS_AR=${OHOS_AR}" >> $GITHUB_ENV
          echo "OHOS_RANLIB=${OHOS_RANLIB}" >> $GITHUB_ENV
          echo "OHOS_STRIP=${OHOS_STRIP}" >> $GITHUB_ENV
          echo "OHOS_SYSROOT=${OHOS_SYSROOT}" >> $GITHUB_ENV
          echo "OHOS_TARGET=${OHOS_TARGET}" >> $GITHUB_ENV
          
          # 测试包装脚本
          ${HOME}/ohos-tools/ohos-clang -c /tmp/test.c -o /tmp/test2.o
          echo "Wrapper script works!"

      - name: Build zlib
        run: |
          echo "=== Building zlib ==="
          cd ${{ github.workspace }}
          wget -q https://zlib.net/zlib-${ZLIB_VERSION}.tar.gz
          tar xzf zlib-${ZLIB_VERSION}.tar.gz
          cd zlib-${ZLIB_VERSION}
          
          CC="$OHOS_CC" AR="$OHOS_AR" RANLIB="$OHOS_RANLIB" CFLAGS="-fPIC -O2" \
          ./configure --prefix=${{ github.workspace }}/install/zlib --static
          
          make -j$(nproc)
          make install
          
          echo "zlib done:"
          file ${{ github.workspace }}/install/zlib/lib/libz.a

      - name: Build OpenSSL
        run: |
          echo "=== Building OpenSSL ==="
          cd ${{ github.workspace }}
          wget -q https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz
          tar xzf openssl-${OPENSSL_VERSION}.tar.gz
          cd openssl-${OPENSSL_VERSION}
          
          CC="$OHOS_CC" CXX="$OHOS_CXX" AR="$OHOS_AR" RANLIB="$OHOS_RANLIB" \
          ./Configure linux-aarch64 \
            --prefix=${{ github.workspace }}/install/openssl \
            --openssldir=${{ github.workspace }}/install/openssl/ssl \
            no-shared no-tests no-asm -fPIC -O2
          
          make -j$(nproc) || make -j2
          make install_sw
          
          echo "OpenSSL done"

      - name: Clone FreeRDP
        run: |
          git clone --depth 1 --branch ${FREERDP_VERSION} \
            https://github.com/FreeRDP/FreeRDP.git ${{ github.workspace }}/FreeRDP

      - name: Patch FreeRDP for OHOS/musl compatibility
        run: |
          echo "=== Patching FreeRDP for OHOS/musl libc compatibility ==="
          cd ${{ github.workspace }}/FreeRDP
          
          # 补丁：禁用 pthread_cancel（musl libc 不支持）
          # 将 #ifndef ANDROID 改为 #if !defined(ANDROID) && !defined(__OHOS__)
          THREAD_FILE="winpr/libwinpr/thread/thread.c"
          
          if [ -f "$THREAD_FILE" ]; then
            echo "Patching $THREAD_FILE to disable pthread_cancel for OHOS..."
            sed -i 's/#ifndef ANDROID/#if !defined(ANDROID) \&\& !defined(__OHOS__)/g' "$THREAD_FILE"
            
            echo "=== Verifying patch ==="
            grep -n "ANDROID\|OHOS" "$THREAD_FILE" | head -10
            echo "Patch applied successfully!"
          else
            echo "WARNING: $THREAD_FILE not found"
            find . -name "thread.c" -path "*/thread/*" | head -5
          fi

      - name: Build FreeRDP
        run: |
          echo "=== Building FreeRDP ==="
          cd ${{ github.workspace }}/FreeRDP
          mkdir build && cd build
          
          # 找 OpenSSL 库路径
          if [ -d "${{ github.workspace }}/install/openssl/lib64" ]; then
            OPENSSL_LIB="${{ github.workspace }}/install/openssl/lib64"
          else
            OPENSSL_LIB="${{ github.workspace }}/install/openssl/lib"
          fi
          
          # 创建 CMake 工具链文件
          cat > /tmp/ohos-toolchain.cmake << EOF
          set(CMAKE_SYSTEM_NAME Linux)
          set(CMAKE_SYSTEM_PROCESSOR aarch64)
          set(CMAKE_C_COMPILER "${OHOS_CC}")
          set(CMAKE_CXX_COMPILER "${OHOS_CXX}")
          set(CMAKE_AR "${OHOS_AR}" CACHE FILEPATH "Archiver")
          set(CMAKE_RANLIB "${OHOS_RANLIB}" CACHE FILEPATH "Ranlib")
          set(CMAKE_STRIP "${OHOS_STRIP}" CACHE FILEPATH "Strip")
          set(CMAKE_C_FLAGS_INIT "-fPIC -O2 -D__OHOS__=1")
          set(CMAKE_CXX_FLAGS_INIT "-fPIC -O2 -D__OHOS__=1")
          set(CMAKE_SHARED_LINKER_FLAGS_INIT "-Wl,--allow-shlib-undefined")
          set(CMAKE_EXE_LINKER_FLAGS_INIT "-Wl,--allow-shlib-undefined")
          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)
          set(CMAKE_POSITION_INDEPENDENT_CODE ON)
          EOF
          
          echo "Toolchain file:"
          cat /tmp/ohos-toolchain.cmake
          
          # 最小化配置，关闭所有非必需功能
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=/tmp/ohos-toolchain.cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install/freerdp \
            -DZLIB_LIBRARY=${{ github.workspace }}/install/zlib/lib/libz.a \
            -DZLIB_INCLUDE_DIR=${{ github.workspace }}/install/zlib/include \
            -DOPENSSL_ROOT_DIR=${{ github.workspace }}/install/openssl \
            -DOPENSSL_INCLUDE_DIR=${{ github.workspace }}/install/openssl/include \
            -DOPENSSL_CRYPTO_LIBRARY=${OPENSSL_LIB}/libcrypto.a \
            -DOPENSSL_SSL_LIBRARY=${OPENSSL_LIB}/libssl.a \
            -DWITH_SERVER=OFF \
            -DWITH_SAMPLE=OFF \
            -DWITH_CUPS=OFF \
            -DWITH_PULSE=OFF \
            -DWITH_ALSA=OFF \
            -DWITH_OSS=OFF \
            -DWITH_FFMPEG=OFF \
            -DWITH_SWSCALE=OFF \
            -DWITH_X11=OFF \
            -DWITH_WAYLAND=OFF \
            -DWITH_GSTREAMER_0_10=OFF \
            -DWITH_GSTREAMER_1_0=OFF \
            -DWITH_LIBSYSTEMD=OFF \
            -DWITH_PCSC=OFF \
            -DWITH_JPEG=OFF \
            -DWITH_OPENH264=OFF \
            -DWITH_GSM=OFF \
            -DWITH_LAME=OFF \
            -DWITH_FAAD2=OFF \
            -DWITH_FAAC=OFF \
            -DWITH_SOXR=OFF \
            -DWITH_OPUS=OFF \
            -DWITH_PKCS11=OFF \
            -DWITH_ICU=OFF \
            -DWITH_KRB5=OFF \
            -DWITH_UNICODE_BUILTIN=ON \
            -DWITH_INTERNAL_RC4=ON \
            -DWITH_INTERNAL_MD4=ON \
            -DWITH_INTERNAL_MD5=ON \
            -DWITH_FUSE=OFF \
            -DWITH_CLIENT_INTERFACE=OFF \
            -DWITH_PROXY=OFF \
            -DWITH_SHADOW=OFF \
            -DWITH_CLIENT=OFF \
            -DWITH_CLIENT_SDL=OFF \
            -DWITH_MANPAGES=OFF \
            -DBUILD_SHARED_LIBS=ON \
            -DWITH_CHANNELS=ON \
            -DWITH_CLIENT_CHANNELS=ON \
            -DWITH_WAYLAND=OFF \
            -DWITH_CAIRO=OFF \
            -DWITH_SWSCALE=OFF \
            -DWITH_SDL_IMAGE_DIALOGS=OFF \
            -DWITH_WEBVIEW=OFF \
            -DWITH_PLATFORM_SERVER=OFF \
            -DWITH_SAMPLE=OFF \
            -DWITH_PROGRESS_BAR=OFF \
            -DWITH_SIMD=OFF \
            -DWITH_NEON=OFF \
            -DWITH_CLIENT_COMMON=OFF \
            -DWITH_SERVER=OFF \
            -DWITH_CUPS=OFF \
            -DWITH_PCSC=OFF \
            -DWITH_LIBSYSTEMD=OFF \
            -DWITH_KEYBOARD_LAYOUT_FROM_FILE=OFF \
            -DCHANNEL_AUDIN=ON \
            -DCHANNEL_ENCOMSP=OFF \
            -DCHANNEL_RAIL=OFF \
            -DCHANNEL_REMDESK=OFF \
            -DCHANNEL_TELEMETRY=OFF \
            -DCHANNEL_URBDRC=OFF \
            -DCHANNEL_SMARTCARD=OFF \
            -DCHANNEL_CLIPRDR=ON \
            -DCHANNEL_RDPDR=OFF \
            -DCHANNEL_RDPSND=ON \
            -DCHANNEL_RDPSND_CLIENT=ON \
            -DCHANNEL_DRDYNVC=ON \
            -DCHANNEL_DISP=ON \
            -DCHANNEL_RDPGFX=ON \
            -DCHANNEL_RDPEI=OFF \
            -DCHANNEL_GEOMETRY=OFF \
            -DCHANNEL_VIDEO=OFF \
            -DWITH_WINPR_TOOLS=OFF \
            -DWITH_BINARY_VERSIONING=OFF \
            2>&1 | tee cmake_output.log
          
          cmake --build . --parallel $(nproc) 2>&1 | tee build_output.log || {
            echo "=== Build failed, showing last 100 lines of output ==="
            tail -100 build_output.log
            exit 1
          }
          
          cmake --install .
          echo "FreeRDP build completed"

      - name: Collect artifacts
        run: |
          mkdir -p ${{ github.workspace }}/artifacts/arm64-v8a
          
          find ${{ github.workspace }}/install/freerdp -name "*.so*" -exec cp {} ${{ github.workspace }}/artifacts/arm64-v8a/ \; 2>/dev/null || true
          
          cd ${{ github.workspace }}/artifacts/arm64-v8a
          
          # 处理符号链接
          for f in *.so*; do
            if [ -L "$f" ]; then
              target=$(readlink -f "$f")
              rm "$f"
              if [ -f "$target" ]; then
                cp "$target" "$(basename $target)"
              fi
            fi
          done
          
          # Strip
          ${OHOS_STRIP} --strip-unneeded *.so* 2>/dev/null || true
          
          # 创建 README
          cat > README.txt << EOF
          FreeRDP HarmonyOS Libraries
          Built: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          FreeRDP: $FREERDP_VERSION
          OpenSSL: $OPENSSL_VERSION (static)
          zlib: $ZLIB_VERSION (static)
          Toolchain: OpenHarmony NDK (musl libc)
          Target: arm64-v8a
          EOF
          
          ls -la

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: freerdp-harmonyos-arm64-v8a
          path: ${{ github.workspace }}/artifacts/arm64-v8a/
          retention-days: 90
          if-no-files-found: warn

  package:
    name: Package Libraries
    needs: [build-ohos-arm64]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: freerdp-harmonyos-arm64-v8a
          path: libs/arm64-v8a

      - name: Create package
        run: |
          cd libs
          echo "FreeRDP HarmonyOS - $(date -u)" > VERSION.txt
          echo "Git SHA: ${{ github.sha }}" >> VERSION.txt
          zip -r ../freerdp-harmonyos-libs.zip .
          cd ..
          sha256sum freerdp-harmonyos-libs.zip > freerdp-harmonyos-libs.zip.sha256

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: freerdp-harmonyos-complete
          path: |
            freerdp-harmonyos-libs.zip
            freerdp-harmonyos-libs.zip.sha256
          retention-days: 90

  release:
    name: Create Release
    needs: [package]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download package
        uses: actions/download-artifact@v4
        with:
          name: freerdp-harmonyos-complete
          path: release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          body: "FreeRDP HarmonyOS Native Libraries (musl libc compatible)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
