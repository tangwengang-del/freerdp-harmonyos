# HarmonyOS应用签名配置指南

## 概述

本项目已配置自动签名流程，适用于虚拟服务器和云调试环境。

## 快速开始

### 1. 获取签名文件

由于在虚拟服务器环境中无法使用虚拟机和真机，建议使用以下方式获取签名文件：

#### 方式A：从华为开发者平台获取（推荐）

1. 访问 [AppGallery Connect](https://developer.huawei.com/consumer/cn/service/josp/agc/index.html)
2. 登录华为开发者账号
3. 创建新应用或选择现有应用
4. 进入 **我的项目** → **证书** → **生成调试证书**
5. 下载以下文件：
   - `debug.p12` - 密钥库文件
   - `debug.cer` - 数字证书文件
   - `debug.p7b` - Provision Profile文件

#### 方式B：从DevEco Studio生成

如果您有其他机器可以运行DevEco Studio：

1. 在DevEco Studio中打开项目
2. 点击 **File** → **Project Structure** → **Signing Configs**
3. 勾选 **Automatically generate signature**
4. 等待生成完成
5. 从项目目录的 `.signing` 文件夹中复制签名文件

### 2. 放置签名文件

将获取的签名文件放置到项目的 `.signing` 目录：

```
c:\huawei\.signing\
  ├── debug.p12
  ├── debug.cer
  └── debug.p7b
```

### 3. 构建应用

#### 使用PowerShell脚本（推荐）

```powershell
# 构建debug版本
.\build-and-sign.ps1

# 构建release版本
.\build-and-sign.ps1 -Release

# 清理后构建
.\build-and-sign.ps1 -Clean
```

#### 使用hvigorw命令

```powershell
# Debug版本
.\hvigorw.bat assembleHap --mode debug

# Release版本
.\hvigorw.bat assembleHap --mode release
```

### 4. 查找生成的HAP文件

构建成功后，HAP文件位于：

```
entry\build\default\outputs\default\entry-default-signed.hap
```

## 签名配置详解

### build-profile.json5 配置

项目已配置以下签名设置：

```json5
{
  "app": {
    "signingConfigs": [
      {
        "name": "default",
        "type": "HarmonyOS",
        "material": {
          "certpath": ".signing/debug.cer",
          "storePassword": "加密的密码",
          "keyAlias": "debugKey",
          "keyPassword": "加密的密码",
          "profile": ".signing/debug.p7b",
          "signAlg": "SHA256withECDSA",
          "storeFile": ".signing/debug.p12"
        }
      }
    ]
  }
}
```

### 密码加密

签名配置中的密码是加密存储的。如果您需要修改密码：

1. 在DevEco Studio中打开项目
2. 进入签名配置界面
3. 输入明文密码后，系统会自动加密

## 云调试配置

### 使用华为云调试

1. 在DevEco Studio中配置云调试连接
2. 连接到远程HarmonyOS设备
3. 运行应用时，DevEco会自动处理签名

### 上传HAP到测试服务器

构建完成后，可以将HAP文件上传到您的测试服务器：

```powershell
# 示例：使用scp上传（需要安装OpenSSH）
scp entry\build\default\outputs\default\*.hap user@server:/path/to/deploy/
```

## CI/CD集成

### GitHub Actions

项目已配置GitHub Actions自动构建流程（`.github/workflows/build-and-sign.yml`）。

要在CI中使用签名，需要配置GitHub Secrets：

1. 进入GitHub仓库的 **Settings** → **Secrets and variables** → **Actions**
2. 添加以下secrets：
   - `SIGNING_P12`: base64编码的debug.p12文件
   - `SIGNING_CER`: base64编码的debug.cer文件
   - `SIGNING_P7B`: base64编码的debug.p7b文件

生成base64编码：

```powershell
# 编码P12文件
$bytes = [System.IO.File]::ReadAllBytes(".signing/debug.p12")
$base64 = [System.Convert]::ToBase64String($bytes)
$base64 | Out-File "debug.p12.base64"

# 对CER和P7B重复相同操作
```

## 故障排查

### 问题1：构建时提示"Unable to create the profile"

**原因**：缺少签名文件或文件路径不正确

**解决方案**：
1. 确认 `.signing` 目录存在
2. 确认包含所有必需文件（.p12, .cer, .p7b）
3. 运行 `.\generate-debug-signature.ps1` 查看详细说明

### 问题2：签名验证失败

**原因**：签名文件与应用Bundle ID不匹配

**解决方案**：
1. 确认 `AppScope/app.json5` 中的 `bundleName` 与签名证书一致
2. 重新生成与当前Bundle ID匹配的签名文件

### 问题3：在虚拟服务器上无法运行DevEco Studio

**解决方案**：
1. 使用方式A从华为开发者平台获取签名文件
2. 或在本地机器生成后上传到服务器
3. 使用命令行工具构建（hvigorw）

## 安全注意事项

1. **不要提交签名文件到Git**
   - `.gitignore` 已配置忽略所有签名文件
   - 仅提交 `.signing/README.md` 说明文件

2. **保护密钥和密码**
   - 不要在代码中硬编码密码
   - 使用环境变量或密钥管理服务

3. **区分开发和生产签名**
   - 开发环境使用debug签名
   - 生产环境使用正式签名证书
   - 不要在生产环境使用调试证书

## 常用命令参考

```powershell
# 查看签名配置
.\generate-debug-signature.ps1

# 构建应用
.\build-and-sign.ps1

# 查看构建输出
Get-ChildItem entry\build\default\outputs -Recurse -Filter "*.hap"

# 清理构建
.\hvigorw.bat clean

# 查看构建日志
Get-Content .hvigor\outputs\logs\details\details.json
```

## 支持与帮助

- [HarmonyOS开发文档](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/application-dev-guide-V5)
- [应用签名指南](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/ide-signing-V5)
- [AppGallery Connect](https://developer.huawei.com/consumer/cn/service/josp/agc/index.html)

## 版本历史

- v1.0 (2026-01-15): 初始签名配置
  - 添加自动签名脚本
  - 配置GitHub Actions
  - 添加签名文件管理
