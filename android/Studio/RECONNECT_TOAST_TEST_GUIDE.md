# 重连原因提示功能测试指南

## 测试准备

### 环境要求
- Android测试设备（建议32位和64位各一台）
- 可控的RDP服务器
- 可以操控网络连接的测试环境

### 测试工具
- Android Logcat（查看日志）
- 网络开关（测试网络断开）
- 任务管理器（强制停止应用测试Service重启）

---

## 测试场景

### 场景1：网络连接断开 ⭐⭐⭐

**目的**: 测试最常见的重连场景

**步骤**:
1. 正常连接到RDP服务器
2. 等待连接稳定（看到桌面画面）
3. 断开WiFi或移动数据
4. 观察Toast提示

**预期结果**:
- ✅ 显示Toast: "🔄 网络连接断开\n5秒后第1/10次重连"
- ✅ 5秒后开始重连尝试
- ✅ 如果网络仍未恢复，显示第2/10、3/10次...

**恢复网络后**:
- ✅ 重连成功后显示: "✓ 重连成功：网络连接断开"
- ✅ Toast 2秒后自动消失

**检查日志**:
```
✓ Toast shown: 🔄 网络连接断开...
Attempting reconnect (attempt 1, reason: 网络连接断开)
✓ Success toast shown: ✓ 重连成功：网络连接断开
```

---

### 场景2：被其他用户踢出 ⭐⭐⭐

**目的**: 测试被踢出场景的重连提示

**前提**: 
- 连接的服务器必须已勾选"被踢出后自动重连"选项
- 可以通过设置 → 高级设置 → 启用该选项

**步骤**:
1. 用账号A连接到RDP服务器
2. 用账号A从另一台设备登录同一服务器（或用不同账号登录到单用户模式服务器）
3. 观察Toast提示

**预期结果**:
- ✅ 显示Toast: "🔄 被其他用户踢出\n5秒后第1/10次重连"
- ✅ 如果勾选了自动重连，5秒后自动重连
- ✅ 重连成功后显示: "✓ 重连成功：被其他用户踢出"

**未勾选自动重连的情况**:
- ✅ 显示对话框提示被踢出
- ✅ 不会自动重连
- ✅ 不显示重连Toast

**检查日志**:
```
🔍 断开原因检测: administrative tool
✅ 检测到被踢出
✓ Toast shown: 🔄 被其他用户踢出...
```

---

### 场景3：后台心跳超时 ⭐⭐

**目的**: 测试后台心跳机制和重连提示

**步骤**:
1. 正常连接到RDP服务器
2. 按Home键或锁屏，让应用进入后台
3. 等待60秒以上（超过KEEPALIVE_TIMEOUT）
4. 切回应用或解锁
5. 观察是否触发重连

**预期结果**（如果触发重连）:
- ✅ 显示Toast: "🔄 后台心跳超时\n..."
- ✅ 自动重连
- ✅ 重连成功后显示成功提示

**注意**: 
- 如果之前的修复生效，正常情况下应该不会误触发
- 只有在真正超时（服务器无响应）时才应该重连

**检查日志**:
```
⚠️ No server update for 16 seconds, triggering reconnection
⚠️ Triggering reconnection due to timeout...
✓ Toast shown: 🔄 后台心跳超时...
```

---

### 场景4：后台Service恢复 ⭐⭐

**目的**: 测试Service被系统杀死后的恢复提示

**步骤**:
1. 正常连接到RDP服务器
2. 按Home键让应用进入后台
3. 打开任务管理器
4. 强制停止应用（或等待系统自动回收）
5. 等待Service自动重启（通过AlarmManager）
6. 切回应用

**预期结果**:
- ✅ Service恢复后自动启动Activity
- ✅ 显示Toast: "🔄 后台服务恢复\n..."
- ✅ 自动重连到服务器
- ✅ 重连成功后显示成功提示

**检查日志**:
```
Service restart detected, recovering session...
✓ Toast shown: 🔄 后台服务恢复...
Starting full reconnection to: [服务器名称]
```

---

### 场景5：认证失败 ⭐

**目的**: 测试认证失败场景（较难模拟）

**步骤**:
1. 修改保存的连接，使用错误的密码
2. 尝试连接
3. 观察Toast提示

**预期结果**:
- ✅ 显示Toast: "🔄 认证失败\n5秒后第1/10次重连"
- ✅ 多次重连失败后显示: "❌ 认证失败\n已尝试10次，无法连接"

**注意**: 
- 实际场景中，认证失败通常不应该自动重连
- 此场景主要测试Toast显示是否正确

---

### 场景6：服务器拒绝连接 ⭐

**目的**: 测试服务器拒绝连接场景

**步骤**:
1. 连接到一个已达到最大连接数的服务器
2. 或连接到已禁用RDP的服务器
3. 观察Toast提示

**预期结果**:
- ✅ 显示Toast: "🔄 服务器拒绝连接\n..."
- ✅ 多次重连失败后显示失败提示

---

### 场景7：多次重连失败 ⭐⭐⭐

**目的**: 测试达到最大重连次数后的提示

**步骤**:
1. 正常连接到RDP服务器
2. 断开网络
3. 观察重连尝试（最多10次）
4. 保持网络断开直到10次全部失败

**预期结果**:
- ✅ 依次显示第1/10、2/10、...、10/10次重连
- ✅ 每次延迟分别为: 5秒、10秒、15秒×8次
- ✅ 10次失败后显示: "❌ 网络连接断开\n已尝试10次，无法连接"
- ✅ 然后显示"登录失败"对话框，并关闭连接

**检查日志**:
```
✓ Toast shown: 🔄 网络连接断开\n5秒后第1/10次重连
...
✓ Toast shown: 🔄 网络连接断开\n15秒后第10/10次重连
...
✗ Failure toast shown: ❌ 网络连接断开\n已尝试10次，无法连接
❌ Max reconnect attempts reached (10), giving up
```

---

### 场景8：快速连续重连 ⭐⭐

**目的**: 测试防抖机制

**步骤**:
1. 正常连接到RDP服务器
2. 快速多次断开/恢复网络（间隔 < 1秒）
3. 观察Toast显示频率

**预期结果**:
- ✅ Toast不会刷屏（防抖机制生效）
- ✅ 最小间隔1秒才显示新的Toast
- ✅ 旧的Toast会被新的Toast取消

**检查日志**:
```
✓ Toast shown: 🔄 网络连接断开...
(< 1秒内的Toast请求被忽略)
```

---

### 场景9：重连成功提示 ⭐⭐⭐

**目的**: 测试成功提示的显示和自动消失

**步骤**:
1. 触发任何一种重连（网络断开、被踢出等）
2. 等待重连成功
3. 观察成功提示

**预期结果**:
- ✅ 重连成功后立即显示: "✓ 重连成功：[原因]"
- ✅ Toast显示时长为LENGTH_SHORT（2秒）
- ✅ 2秒后自动消失
- ✅ 同一次重连过程中，成功提示只显示一次

**检查日志**:
```
OnConnectionSuccess
✓ Success toast shown: ✓ 重连成功：网络连接断开
```

---

## 性能测试

### 测试1：重连速度影响

**步骤**:
1. 记录修改前的重连速度（从断开到重连成功的总时间）
2. 记录修改后的重连速度
3. 对比差异

**预期结果**:
- ✅ 速度差异 < 1%（< 50ms）
- ✅ Toast显示不会阻塞重连过程

### 测试2：内存占用

**步骤**:
1. 使用Android Profiler监测内存
2. 触发多次重连
3. 观察内存增长

**预期结果**:
- ✅ 内存增长 < 1KB
- ✅ Toast显示不会导致内存泄漏
- ✅ onDestroy后Toast管理器被正确释放

### 测试3：多设备兼容性

**测试设备**:
- 32位Android设备
- 64位Android设备
- Android 8.0以下系统
- Android 10+系统

**预期结果**:
- ✅ 所有设备上Toast都能正常显示
- ✅ 无崩溃或异常

---

## 日志检查清单

### 必须出现的日志

**初始化**:
```
✓ ReconnectToastManager initialized
```

**重连触发**:
```
✓ Toast shown: 🔄 [原因]\n...
Scheduling reconnect attempt X/10 in Y seconds (reason: [原因])
```

**重连成功**:
```
OnConnectionSuccess
✓ Success toast shown: ✓ 重连成功：[原因]
```

**清理**:
```
Toast manager cleaned
```

---

## 常见问题排查

### 问题1: Toast没有显示

**可能原因**:
1. 防抖机制触发（< 1秒内的重复请求被忽略）
2. toastManager未初始化
3. Activity已销毁

**检查**:
- 查看日志是否有 "✓ ReconnectToastManager initialized"
- 查看日志是否有 "✓ Toast shown: ..."
- 确认Activity状态

### 问题2: Toast显示但内容不对

**可能原因**:
1. 重连原因判断逻辑错误
2. errorString内容与预期不符

**检查**:
- 查看 "🔍 断开原因检测: [errorString]" 日志
- 确认重连原因枚举是否匹配

### 问题3: 重连速度变慢

**可能原因**:
1. UI线程阻塞
2. Toast创建耗时过长

**检查**:
- 使用Android Profiler测量Toast创建时间
- 确认Toast创建在主线程runOnUiThread中执行

---

## 测试报告模板

```markdown
## 重连原因提示功能测试报告

**测试日期**: YYYY-MM-DD
**测试设备**: [型号、Android版本、架构]
**测试人员**: [姓名]

### 测试结果总览

| 场景 | 通过 | 失败 | 备注 |
|-----|------|------|------|
| 网络连接断开 | ✅ | ❌ | |
| 被其他用户踢出 | ✅ | ❌ | |
| 后台心跳超时 | ✅ | ❌ | |
| 后台Service恢复 | ✅ | ❌ | |
| 多次重连失败 | ✅ | ❌ | |
| 重连成功提示 | ✅ | ❌ | |

### 详细测试记录

#### 场景1: 网络连接断开
- **执行时间**: HH:MM:SS
- **结果**: 通过/失败
- **观察到的Toast**: [实际显示内容]
- **日志截图**: [附件]
- **备注**: [任何异常情况]

[重复其他场景...]

### 性能测试结果

- **重连速度影响**: X ms (X%)
- **内存占用增长**: X KB
- **Toast显示延迟**: X ms

### 发现的问题

1. [问题描述]
   - **严重程度**: 高/中/低
   - **复现步骤**: ...
   - **建议修复**: ...

### 总体评价

- **功能完整性**: 优秀/良好/一般/较差
- **用户体验**: 优秀/良好/一般/较差
- **性能影响**: 可忽略/轻微/中等/严重
- **建议**: [是否可以发布]
```

---

**测试建议优先级**:
1. ⭐⭐⭐ 场景1、2、7、9（核心功能）
2. ⭐⭐ 场景3、4、8（重要功能）
3. ⭐ 场景5、6（边缘情况）

**预计测试时间**: 
- 快速测试：30分钟（只测试⭐⭐⭐场景）
- 完整测试：2小时（测试所有场景）
- 深度测试：4小时（包括性能测试和多设备测试）


