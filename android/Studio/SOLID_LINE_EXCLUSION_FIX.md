# 排除长实线的改进方案

## 问题
明明是一根很长的红实线，也被误判为虚实线。

## 原因分析

### 场景重现
```
检测范围内的像素序列（100px）：
[红红红红红红...红红红 背景 红红红红红...红红红]
 ←─── 45px ───→  2px  ←─── 45px ───→

旧逻辑判断：
- 线段数 = 2 ✓
- 断开数 = 1 ✓  
- 最长段 = 45px > 30px ✗ → 应该排除，但如果是28px就会误判 ✓
→ 误判为虚实线！
```

**根本问题：** 一根长实线可能被其他元素（背景、文字、边框等）"断开"，形成多个红色段，但总长度仍然很长，应该被识别为实线。

## 解决方案

### 新增两个判断条件

#### 1. **真正的断开** (>= 3px)
```java
// 只有断开 >= 3px 才算真正的断开
if (seg.length >= 3)
{
    gapCount++;
}
```

**原因：** 1-2px的断开可能只是噪点或抗锯齿效果，不是虚实线的"断开"。

#### 2. **线段占比** (< 80%)
```java
int totalLineLength = 0;   // 所有红/绿线段的总长度
// ... 累加所有线段长度 ...
int linePercentage = (totalLineLength * 100) / pixels.length;
```

**核心逻辑：** 
- 虚实线：`25px实 - 5px空 - 5px实 - 5px空` → 占比约 `(25+5)/(25+5+5+5+5) = 30/45 = 67%`
- 长实线：`45px实 - 2px断 - 45px实` → 占比 `(45+45)/(45+2+45) = 90/92 = 98%` ✗

**阈值：80%** → 如果红/绿色占比 >= 80%，说明是实线，要排除！

## 完整判断条件

```java
boolean hasPattern = 
    (lineSegmentCount >= 2) &&      // 至少2个线段
    (gapCount >= 1) &&               // 至少1个真正的断开(>=3px)
    (maxLineLength <= 30) &&         // 最长段<=30px
    (linePercentage < 80);           // 线段占比<80%
```

## 对比测试

### 测试1：真实虚实线
```
模式：[25红][5空][5红][5空][25红]
总长度：65px
红色长度：55px (25+5+25)
占比：55/65 = 85%... 不对！

重新计算：
模式：[25红][5空][5红][5空]
红色段：[25px, 5px]
最长段：25px ✓
断开：[5px, 5px] → 2个>=3px的断开 ✓
占比：(25+5)/40 = 75% ✓
→ 判断为虚实线 ✓
```

### 测试2：长实线（被背景断开）
```
模式：[45红][2背景][43红]
总长度：90px
红色长度：88px
最长段：45px ✗ (>30px)
占比：88/90 = 98% ✗ (>=80%)
→ 排除 ✓
```

### 测试3：长实线（多次被断开）
```
模式：[28红][2空][28红][1空][28红]
总长度：87px
红色长度：84px
最长段：28px ✓ (<30px)
断开：[2空] 不算(<3px), [1空] 不算(<3px)
真正断开数：0 ✗
→ 排除 ✓
```

### 测试4：长实线（被断开但占比高）
```
模式：[29红][4空][29红][4空][29红]
总长度：95px
红色长度：87px
最长段：29px ✓
断开：[4px, 4px] → 2个>=3px ✓
占比：87/95 = 92% ✗ (>=80%)
→ 排除 ✓
```

## 参数调整

### 断开阈值 (当前: 3px)
```java
if (seg.length >= 3)  // 真正的断开
```

**调整建议：**
- 如果虚实线的"空"很小（1-2px）：降低到 `>= 2`
- 如果噪点干扰多：提高到 `>= 4`

### 占比阈值 (当前: 80%)
```java
linePercentage < 80  // 线段占比
```

**调整建议：**
- 虚实线模式 `25-5-5-5` → 理论占比 67%
- 虚实线模式 `20-5-10-5` → 理论占比 75%
- **安全阈值：80%** (留有余量)

如果误判：
- 真实线被排除 → 降低阈值到 75%
- 长实线未排除 → 提高阈值到 85%

## 调试日志

### 成功检测虚实线
```
✓ 虚实线检测成功: 3个线段, 2个断开, 最长线段=25px, 线段占比=68%
```

### 排除长实线
```
✗ 检测失败: 线段=2, 断开=1, 最长线段=45px, 线段占比=95% 
   (实线排除规则: 最长段>30px 或 占比>=80%)
```

```
✗ 检测失败: 线段=3, 断开=2, 最长线段=28px, 线段占比=92% 
   (实线排除规则: 最长段>30px 或 占比>=80%)
```

## 总结

### 旧逻辑问题
```
只检查单个段的长度 → 长实线被背景断开 → 误判为虚实线
```

### 新逻辑改进
```
1. 真正的断开(>=3px) → 排除噪点干扰
2. 线段总占比(<80%) → 排除长实线
3. 单段长度(<=30px) → 保持原有规则
```

### 核心思想
**虚实线 = 断断续续（占比低）**  
**长实线 = 基本连续（占比高，即使有断开）**

### 四重保护
1. ✅ 至少2个线段（有红/绿色）
2. ✅ 至少1个真正断开（>=3px，排除噪点）
3. ✅ 单段不超过30px（排除大段实线）
4. ✅ **总占比<80%**（排除多段实线）

**现在长实线不会再被误判了！**


