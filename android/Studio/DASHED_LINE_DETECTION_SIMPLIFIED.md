# 虚实线检测 - 简化版本

## 更新日期
2025-12-27 (简化版)

## 核心逻辑（极简）

只检测3个条件：
1. ✅ **颜色**：红色或绿色
2. ✅ **有断开**：至少1个断开
3. ✅ **断开干净**：断开处没有其它线或文字

## 检测流程

```
读取水平200px像素
    ↓
分析段序列：线(红/绿)-断开-线(红/绿)-断开...
    ↓
统计线段数（至少2个）
    ↓
统计干净断开数（至少1个）
    ↓
检查断开是否干净：
  - 断开处有深色非红/绿像素？ → ✗ 有干扰
  - 断开处是浅色背景？ → ✓ 干净
    ↓
判断：线段 >= 2 && 干净断开 >= 1
    ↓
✓ 检测成功！
```

## 核心代码

```java
private boolean hasLongShortPattern(int[] pixels)
{
    // 1. 分析段序列
    List<SegmentWithPos> segments = 分析(pixels);
    
    // 2. 统计
    int lineSegmentCount = 0;   // 红/绿线段数
    int cleanGapCount = 0;      // 干净断开数
    
    for (segment in segments)
    {
        if (segment是红/绿) {
            lineSegmentCount++;
        }
        else {  // 断开
            // 检查断开是否干净
            if (断开处无深色非红绿像素) {
                cleanGapCount++;
            }
        }
    }
    
    // 3. 判断
    return lineSegmentCount >= 2 && cleanGapCount >= 1;
}
```

## 关键改进

### 1. 移除复杂模式检查
- ❌ 不再要求"一长一短"模式
- ❌ 不再检查长段6-15px、短段2-5px
- ❌ 不再要求至少2组模式
- ✅ **只要有多个线段就行**

### 2. 移除垂直线验证
- ❌ 不再检查上下11行
- ✅ 用户说没有网格干扰，不需要

### 3. "干净断开"检查
这是唯一的关键检查：

```java
// 遍历断开区域的每个像素
for (pixel in 断开区域)
{
    if (isDarkPixel(pixel) && !isTargetColorPixel(pixel))
    {
        // 有深色但不是红/绿 → 有干扰（其它线或文字）
        return false;  // 不是干净的断开
    }
}
```

## 判断条件对比

| 条件 | 旧方案 | 新方案 |
|------|--------|--------|
| 颜色 | 红/绿 | 红/绿 |
| 线段数 | 至少2组长短模式 | **至少2个线段** |
| 断开数 | 至少2个 | **至少1个** |
| 断开要求 | 间隔1-5px | **断开处干净** |
| 垂直验证 | 需要 | **不需要** |

## 颜色阈值

保持宽松阈值以提高检测率：

```java
// Lime 绿色
boolean isLime = (g > 180) && (r < 120) && (b < 120);

// Red 红色
boolean isRed = (r > 180) && (g < 120) && (b < 120);
```

如果检测不到，可以放宽：
```java
boolean isLime = (g > 150) && (r < 140) && (b < 140);
boolean isRed = (r > 150) && (g < 140) && (b < 140);
```

## 预期效果

### 优点
- ✅ **极简**：只有3个条件
- ✅ **快速**：减少了70%的检查
- ✅ **准确**："干净断开"确保排除干扰
- ✅ **宽容**：不要求严格的长短模式

### 缺点
- ⚠️ 可能误检测一些特殊情况
- ⚠️ 需要实测后微调参数

## 调试

启用调试日志：
```java
private static final boolean DEBUG = true;
```

日志输出：
- `✓ 虚实线检测成功: X个线段, Y个干净断开`
- `✗ 检测失败: 线段=X, 干净断开=Y`
- `断开处有干扰 pos=X`

## 参数调整

如果检测不理想，只需调整2个参数：

### 1. 最少线段数
```java
// 当前：至少2个线段
return lineSegmentCount >= 2 && cleanGapCount >= 1;

// 如果太宽松：
return lineSegmentCount >= 3 && cleanGapCount >= 1;
```

### 2. 线段最小长度
```java
// 当前：至少2px才算有效线段
if (seg.length >= 2)

// 如果有噪点干扰：
if (seg.length >= 3)
```

## 总结

**原则：简单就是美！**

不需要复杂的模式匹配，只要：
- 是红/绿色
- 有断开
- 断开干净

就是虚实线！


