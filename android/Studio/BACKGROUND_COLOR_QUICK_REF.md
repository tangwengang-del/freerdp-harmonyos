# 背景色检测优化 - 快速参考

## 🎯 优化内容

针对**DarkGray / Gray / SlateGray** 三种特定灰色背景优化了 `isBackgroundColor()` 方法。

---

## 📊 背景色识别范围

| 背景色名称 | 标准RGB值 | 识别范围 | 容差 |
|-----------|-----------|----------|------|
| **DarkGray** | (169, 169, 169) | R: 144-194<br>G: 144-194<br>B: 144-194 | ±25 |
| **Gray** | (128, 128, 128) | R: 103-153<br>G: 103-153<br>B: 103-153 | ±25 |
| **SlateGray** | (112, 128, 144) | R: 87-137<br>G: 103-153<br>B: 119-169 | ±25 |

---

## ✅ 核心判断逻辑

### **DarkGray 和 Gray（纯灰色）**
```
1. RGB三个值都在容差范围内（±25）
2. RGB之间的差值 ≤ 25（确保是纯灰色）
```

### **SlateGray（蓝灰色）**
```
1. RGB三个值都在各自容差范围内（±25）
2. 验证渐变关系：R ≤ G+20 且 G ≤ B+20
   （因为SlateGray是 R<G<B 的蓝灰色）
```

---

## 🔍 测试验证清单

### ✓ 必测场景

- [ ] **DarkGray背景** + 红色虚实线 → 虚实线应被正确检测
- [ ] **Gray背景** + 绿色虚实线 → 虚实线应被正确检测
- [ ] **SlateGray背景** + 红色虚实线 → 虚实线应被正确检测
- [ ] **DarkGray背景** + 蓝色竖线穿过红色虚实线 → 竖线应被排除
- [ ] 虚实线边缘（抗锯齿像素）→ 应正确识别为背景或线条

### ✓ 边界条件测试

测试以下RGB值是否正确识别：

| RGB值 | 预期结果 | 说明 |
|-------|----------|------|
| (169, 169, 169) | ✅ 背景 | DarkGray标准值 |
| (194, 194, 194) | ✅ 背景 | DarkGray容差边界 |
| (195, 195, 195) | ❌ 非背景 | 超出容差 |
| (128, 128, 128) | ✅ 背景 | Gray标准值 |
| (112, 128, 144) | ✅ 背景 | SlateGray标准值 |
| (112, 144, 128) | ❌ 非背景 | 不符合R<G<B |
| (0, 255, 0) | ❌ 非背景 | Lime绿 |
| (255, 0, 0) | ❌ 非背景 | Red红 |

---

## 🔧 参数调优

如果测试发现问题，调整以下参数：

### **容差调整**（行949）
```java
int tolerance = 25;  // 当前值

// 问题：背景色被误判为线条
→ int tolerance = 30;  // 放宽容差

// 问题：其他颜色被误判为背景
→ int tolerance = 20;  // 收紧容差
```

### **SlateGray渐变验证**（行986）
```java
if (r <= g + 20 && g <= b + 20)  // 当前值

// 问题：SlateGray识别率低
→ if (r <= g + 25 && g <= b + 25)  // 放宽

// 问题：其他蓝色被误判为背景
→ if (r <= g + 15 && g <= b + 15)  // 收紧
```

---

## 🎨 颜色对照表

### **虚实线颜色 vs 背景色差异**

| 颜色 | RGB值 | 与DarkGray差值 | 与Gray差值 | 会被误判吗？ |
|------|-------|---------------|-----------|-------------|
| Lime绿 | (0, 255, 0) | G差=86 | G差=127 | ❌ 不会 |
| Red红 | (255, 0, 0) | R差=86 | R差=127 | ❌ 不会 |
| DarkGray | (169, 169, 169) | 0 | R/G/B差=41 | ✅ 正确识别为背景 |
| Gray | (128, 128, 128) | R/G/B差=41 | 0 | ✅ 正确识别为背景 |
| SlateGray | (112, 128, 144) | - | - | ✅ 正确识别为背景 |

---

## 📝 代码位置

- **文件**: `TouchPointerView.java`
- **方法**: `isBackgroundColor(int pixel)` 
- **行号**: 940-993

---

## ⚠️ 重要提示

1. **只支持这3种背景**：DarkGray、Gray、SlateGray
2. **不支持其他背景**：白色、黑色、彩色背景需另外添加
3. **容差±25约为10%**：考虑了抗锯齿和显示器色差
4. **SlateGray需特殊验证**：因为有蓝色偏向（R<G<B）

---

## 📞 故障排查

### 问题1: 背景色被识别为线条
**症状**: 虚实线检测在背景区域误报  
**解决**: 放宽容差，从25增加到30

### 问题2: 虚实线被识别为背景
**症状**: 红/绿虚实线无法检测  
**解决**: 检查虚实线颜色是否为标准Lime/Red

### 问题3: SlateGray识别失败
**症状**: SlateGray背景下虚实线检测异常  
**解决**: 
1. 检查实际背景RGB是否为 (112, 128, 144)
2. 放宽渐变验证：`r <= g + 25 && g <= b + 25`

### 问题4: 竖线无法排除
**症状**: 竖线被误判为虚实线一部分  
**解决**: 检查竖线颜色是否在5行中≥3行出现

---

**最后更新**: 2026-01-03
