# 虚实线长线段检查优化 - 2026-01-03

## 📋 修改内容

### ✅ 修改：删除断开检查，只保留长线段检查

**问题分析：**
- 断开长度难以准确测量（受背景色影响）
- 预检查阶段扫描300px范围，容易误判背景为"长断开"
- 导致真正的虚实线被错误排除

**解决方案：**
- ❌ 删除断开(>15px)的检查
- ✅ 保留长线段(>30px)的检查（排除直线）
- ✅ 将阈值从20px提升到30px（更合理）

---

## 🔧 具体修改

### **1. 修改预检查调用（行766-767）**

**修改前：**
```java
// 预检查：排除有>15px断开或>20px长线段的情况（不是虚实线）
if (hasLongGapOrSegment(bitmap, y, leftBound, rightBound)) return false;
```

**修改后：**
```java
// 预检查：排除有>30px长线段的情况（可能是直线，不是虚实线）
if (hasVeryLongSegment(bitmap, y, leftBound, rightBound)) return false;
```

---

### **2. 重写检查方法（行808-859）**

**修改前：** `hasLongGapOrSegment()`
- 检查>20px的线段 → 排除
- 检查>15px的断开 → 排除
- 方法名不够准确

**修改后：** `hasVeryLongSegment()`
```java
// 辅助方法：检查是否有过长的线段(>30px)，用于快速排除直线
private boolean hasVeryLongSegment(Bitmap bitmap, int y, int startX, int endX)
{
    // ... 读取像素 ...
    
    for (int i = 1; i < pixels.length; i++)
    {
        boolean currentTarget = isTargetColorPixel(pixels[i]);
        
        if (currentTarget == isTarget)
        {
            segmentLength++;
        }
        else
        {
            // 只检查线段（深色）是否过长
            if (isTarget && segmentLength > 30)
            {
                return true;  // 有>30px的线段，可能是直线
            }
            // ✅ 断开（浅色）不检查，因为难以准确测量
            
            isTarget = currentTarget;
            segmentLength = 1;
        }
    }
    
    // 检查最后一段
    if (isTarget && segmentLength > 30)
    {
        return true;
    }
    
    return false;
}
```

---

## 📊 修改对比

| 检查项 | 修改前 | 修改后 | 原因 |
|--------|--------|--------|------|
| **长线段阈值** | >20px | >30px | 虚实线实部可能达到20px |
| **断开检查** | >15px排除 | ❌ 删除 | 难以准确测量，容易误判 |
| **方法名** | hasLongGapOrSegment | hasVeryLongSegment | 更准确反映功能 |

---

## 🎯 修改原理

### **为什么删除断开检查？**

1. **测量困难**：
   - 扫描的是300px范围（左右各150px）
   - 包含：虚实线、背景、其他元素
   - 背景区域会被误判为"长断开"

2. **误判案例**：
   ```
   [背景20px] [虚实线: 5px-断开-10px-断开-5px] [背景30px]
   ↑ 误判为长断开 → 整个检测失败！
   ```

3. **正确方法**：
   - 在**阶段3统计**时限制断开范围（3-9px）
   - 只统计虚实线本身的断开
   - 不在预检查阶段判断

### **为什么保留长线段检查？**

1. **目的明确**：
   - 快速排除**直线**（实线）
   - 直线通常>30px连续

2. **测量准确**：
   - 红/绿色目标颜色容易识别
   - 不受背景色干扰

3. **阈值合理**：
   - 虚实线的"实"部分通常5-20px
   - 很少超过30px
   - >30px基本可以判断是直线

---

## ✅ 预期效果

1. **减少误判**：
   - 不再因背景区域被误判为"长断开"而排除虚实线
   - 提高检测成功率

2. **保留直线排除**：
   - 仍能快速排除>30px的长线段（直线）
   - 提高检测效率

3. **依赖正确统计**：
   - 阶段3统计限制断开范围（3-9px）
   - 阶段3统计限制线段范围（3-15px）
   - 更准确地判断虚实线模式

---

## 🧪 测试场景

### **应该通过的情况：**
- ✅ 虚实线（5px-断开-10px-断开-8px）
- ✅ 虚实线周围有背景区域（>15px）
- ✅ 虚实线实部长度20-30px

### **应该被排除的情况：**
- ❌ 直线（连续35px的线段）
- ❌ 标注线（连续40px的线段）

---

## 📝 修改位置

**文件：** `TouchPointerView.java`

**修改行号：**
1. 行766-767：更新预检查调用
2. 行808-859：重写 `hasVeryLongSegment()` 方法
   - 删除断开检查逻辑
   - 线段阈值从20改为30
   - 更新方法名和注释

---

## ✅ 编译状态

- ✅ 编译通过
- ✅ 无linter错误
- ✅ 逻辑完整

---

**修改日期：** 2026-01-03  
**修改原因：** 删除不准确的断开检查，只保留准确的长线段检查  
**预期效果：** 提高虚实线检测成功率，减少误排除
