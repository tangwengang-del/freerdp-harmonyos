# 虚实线自动对准功能

## 功能说明

当鼠标松开左键或中键后，系统会立即执行两步检测：第一步快速扫描Y±4像素（共9行）范围内是否有红绿线，第二步详细判定是否为虚实线。如果检测到虚实线，指针会自动平滑移动并精准对准该虚实线，同时十字形指针变为红色，方便用户拖动虚实线目标。

## 核心特性

✅ **立即检测**：松开鼠标左键/中键后立即扫描（无延迟）  
✅ **两步检测**：第一步快速扫描Y±4像素×10px，第二步详细判定Y±2像素×200px  
✅ **精准对准**：自动移动指针到最近的虚实线  
✅ **视觉反馈**：检测到虚实线后，十字形显示红色  
✅ **保证覆盖**：最远4像素能检测到，无虚实线场景快11倍  
✅ **平滑动画**：200ms平滑移动动画，体验流畅  
✅ **不干扰拖动**：红色状态与拖动操作完全独立

## 虚实线定义

虚实线模式：**一长一短**

```
━━━━━━━ ━ ━━━━━━━ ━ ━━━━━━━ ━
 长线段  短 长线段  短 长线段  短
 6-12px 2-4 6-12px
```

### 识别参数

- **长段长度**：6-12 像素
- **短段长度**：2-4 像素
- **线条颜色**：深色（亮度 < 100）
- **间隔颜色**：浅色或背景色

## 如何在远程服务器上设置虚实线

### Windows 应用示例

在您的Windows应用程序中，使用以下方式绘制虚实线作为可拖动目标：

#### 方法1：使用GDI+（C#）

```csharp
// 创建一长一短的虚线样式
float[] dashPattern = { 10f, 2f, 3f, 2f };  // 长10px, 间隔2px, 短3px, 间隔2px
Pen dashedPen = new Pen(Color.Black, 1);
dashedPen.DashPattern = dashPattern;

// 绘制水平虚实线
graphics.DrawLine(dashedPen, startX, y, endX, y);
```

#### 方法2：使用WinForms

```csharp
// 在OnPaint事件中
Pen pen = new Pen(Color.Black, 1);
pen.DashStyle = DashStyle.DashDot;  // 内置的虚实线样式
e.Graphics.DrawLine(pen, startX, y, endX, y);
```

#### 方法3：使用WPF

```xml
<Line X1="0" Y1="100" X2="300" Y2="100" 
      Stroke="Black" 
      StrokeThickness="1"
      StrokeDashArray="10 2 3 2"/>
```

### 网页应用示例（如果通过浏览器远程）

#### CSS实现

```css
.draggable-line {
    border-top: 1px dashed #000;
    /* 或使用自定义虚线 */
    border-top: 1px solid #000;
    border-image: repeating-linear-gradient(
        to right,
        #000 0px, #000 10px,
        transparent 10px, transparent 12px,
        #000 12px, #000 15px,
        transparent 15px, transparent 17px
    ) 1;
}
```

#### Canvas绘制

```javascript
const ctx = canvas.getContext('2d');
ctx.strokeStyle = '#000';
ctx.lineWidth = 1;
ctx.setLineDash([10, 2, 3, 2]);  // 长10px, 间隔2px, 短3px, 间隔2px
ctx.beginPath();
ctx.moveTo(startX, y);
ctx.lineTo(endX, y);
ctx.stroke();
```

## 使用流程

```
1. 用户移动触摸指针到虚实线附近
   ↓
2. 松开鼠标左键或中键
   ↓
3. 系统立即执行两步检测：
   【第一步】快速扫描Y±4像素×10px，查找红绿线（90像素）
   【第二步】详细判定Y±2像素×200px，确认虚实线（1000像素）
   ↓
4. 检测到虚实线
   ↓
5. 指针自动平滑移动到虚实线（Y坐标精准对准）
   ↓
6. 十字形指针变红色
   ↓
7. 用户可拖动虚实线
   ↓
8. 离开虚实线范围后，指针恢复黑色
```

## 技术实现

### 核心文件

1. **TouchPointerView.java**
   - 鼠标松开检测机制（立即触发）
   - 两步虚实线检测算法
   - 自动移动动画
   - 红色状态管理

2. **SessionActivity.java**
   - 提供Bitmap访问接口
   - 设置TouchPointerView引用

### 检测算法

```
【第一步：快速预扫描】
1. 读取指针Y坐标±4像素范围内的9行×10px像素（共90像素）
2. 检测是否有红色或绿色像素
3. 如果没有 → 结束检测（快11倍）
4. 如果有 → 记录红绿线Y坐标，进入第二步

【第二步：详细判定】
5. 读取红绿线Y坐标±2像素范围内的5行×200px像素（共1000像素）
6. 分析像素模式，判定是否符合虚实线特征：
   - 线段数 ≥ 2
   - 断开数 ≥ 2
   - 最长线段 ≤ 30px
7. 按距离排序，选择最近的虚实线
8. 自动移动指针到该虚实线的Y坐标
```

### 性能优化

- ✅ 后台线程执行检测（不阻塞UI）
- ✅ 小范围扫描（200×9像素）
- ✅ 批量读取像素（getPixels性能高）
- ✅ 只在静止时检测（避免频繁计算）
- ✅ 动画过程中禁用静止检测（避免干扰）

## 调试日志

启用DEBUG模式查看详细日志：

```java
private static final boolean DEBUG = true;  // 在TouchPointerView.java中设置
```

日志输出示例：
```
Pointer still, detecting dashed line...
找到虚实线 Y=245, 距离=2px, 自动移动中...
自动移动完成: (320,245), 目标Y=245
进入虚实线区域 → 红色
离开虚实线区域 → 黑色
```

## 测试建议

### 1. 基本功能测试
- 在远程桌面绘制符合规格的虚实线
- 移动指针到虚实线附近（±2像素内）
- 停止移动500ms
- 观察指针是否自动对准并变红

### 2. 边界测试
- 测试虚实线在屏幕边缘的情况
- 测试指针在虚实线正上方/正下方
- 测试多条虚实线时选择最近的

### 3. 拖动测试
- 对准后拖动虚实线
- 确认在±2像素范围内保持红色
- 确认离开范围后恢复黑色
- 确认拖动操作不受影响

## 常见问题

### Q1: 指针没有自动移动？
**A**: 检查以下几点：
1. 虚实线是否符合规格（长6-12px，短2-4px）
2. 线条是否是深色（亮度<100）
3. 指针是否在虚实线±2像素范围内
4. 是否静止了足够时间（500ms）

### Q2: 检测到错误的目标？
**A**: 可能原因：
1. 附近有其他符合模式的图案
2. 背景有干扰图案
3. 调整虚实线的长短比例使其更独特

### Q3: 移动动画不流畅？
**A**: 检查：
1. 设备性能是否足够
2. 是否有其他卡顿操作
3. 动画时长可调整（默认200ms）

## 未来改进方向

- [ ] 支持可配置的虚实线模式
- [ ] 添加开关控制功能启用/禁用
- [ ] 支持倾斜的虚实线
- [ ] 增加触觉反馈（震动）
- [ ] 机器学习优化检测精度

## 版本历史

**v1.0** - 2025-12-27
- ✅ 初始实现
- ✅ 静止检测
- ✅ 虚实线识别
- ✅ 自动对准
- ✅ 红色状态显示


